(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[8344],{8344:(O,M,r)=>{r.r(M),r.d(M,{CopilotChatMessageService:()=>X,CopilotChatService:()=>R,CopilotFileValidatorService:()=>H,CopilotMentionService:()=>ne,CopilotModule:()=>Ve,CopilotService:()=>B});var c=r(5960),P=r(3602),V=r(55642),S=r(79772),j=r(68651),T=r(40297),u=r(59131),x=r(63721),y=r(66486),I=r(13443),_=r(28399),l=r(62278),A=r(36486);const Bt=new u.InjectionToken("OptionsSkipUnsuccessfulResponseHandling"),Wt=new u.InjectionToken("SchemaDesignerApiUrl"),Kt=new u.InjectionToken("SchemaDesignerConverter");var v=r(6530),ae=r(26594);function Qt(){return`BusinessRule_${(0,v.qv)().substring(0,7)}`}var ye;(function(a){a.BusinessRule="BusinessRule",a.RelatedPage="RelatedPage",a.TimelineEntity="TimelineEntity",a.AppearanceSettings="AppearanceSettings",a.Sidebar="Sidebar",a.UCTestAddon="UCTestAddon"})(ye||(ye={}));var Us=r(26544);class Fe extends Us.D{constructor(e){super(e),this.typeName="Terrasoft.Core.Addons.AddonSchema",this.metaData=e.metaData,this.addonName=e.addonName,this.targetSchemaUId=e.targetSchemaUId,this.targetSchemaManagerName=e.targetSchemaManagerName,this.typeName=e.typeName,this.id=e.id,this.parentSchemaUId=e.parentSchemaUId,this.package=e.package,this.resources=e.resources,this.useFullHierarchy=e.useFullHierarchy}clone(){return new Fe(this)}set addonConfig(e){this.metaData=JSON.stringify(e,null,"	")}get addonConfig(){try{return JSON.parse(this.metaData)}catch{throw new Error("Invalid addon JSON metadata received from server")}}equal(e){return this.metaData===e.metaData&&this.addonName===e.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName&&this.targetSchemaUId===e.targetSchemaUId&&this.typeName===e.typeName&&this.extendParent===e.extendParent&&this.uId===e.uId&&this.name===e.name&&this.packageUId===e.packageUId&&this.caption===e.caption&&this.id===e.id&&this.parentSchemaUId===e.parentSchemaUId}}class Se{constructor(...e){if(this._isLoaded=!1,this._isChanged=!1,this.id=(0,v.qv)(),e[0]instanceof Se){const t=e[0];this.addonName=t.addonName,this._targetSchemaUId=t.targetSchemaUId,this.targetSchemaManagerName=t.targetSchemaManagerName,this.targetParentSchemaUId=t.targetParentSchemaUId,this.targetPackageUId=t.targetPackageUId,this.id=t.id,this._apiService=t._apiService,this._isLoaded=t._isLoaded,this._isChanged=t._isChanged,t._schema&&(this._schema=t._schema.clone()),this.useFullHierarchy=t.useFullHierarchy}else this.addonName=e[0],this._targetSchemaUId=e[1],this.targetParentSchemaUId=e[2],this.targetPackageUId=e[3],this.targetSchemaManagerName=e[4],this._apiService=e[5],this.useFullHierarchy=e[6]}get schema$(){return this._isLoaded?(0,l.of)(this._schema):this._loadSchema()}get isChanged(){return this._isChanged}get resources(){return this._resources}get targetSchemaUId(){return this._targetSchemaUId}set targetSchemaUId(e){this._targetSchemaUId=e,this._schema&&(this._schema.targetSchemaUId=e)}get addonConfig(){return this.schema$.pipe((0,A.map)(e=>{const t=e.addonConfig;return this._setMetadataDefValues(t),t}))}set addonConfig(e){(0,l.forkJoin)([this.schema$,e]).subscribe(([t,s])=>{t.addonConfig=s,this._isChanged=!0})}_setMetadataDefValues(e){this.addonName===ye.BusinessRule&&e.rules?.forEach(s=>{s.name=s.name||Qt(),s.enabled=s.enabled||s.enabled===void 0})}_setAddonResources(e){this._resources=e.map(t=>{const s=t.key.split(".");return{key:[s[2],s[3]].join("."),value:t.value}}),this._schema.resources=[...this._resources]}_loadSchema(){return this._schema$?this._schema$:(this._schema$=this._apiService.getAddon({targetSchemaUId:this.targetSchemaUId,addonName:this.addonName,targetParentSchemaUId:this.targetParentSchemaUId,targetPackageUId:this.targetPackageUId,targetSchemaManagerName:this.targetSchemaManagerName,useFullHierarchy:this.useFullHierarchy}).pipe((0,A.tap)(e=>{e.success&&(this._schema=new Fe(e.schema),this._schema.typeName="Terrasoft.Core.Addons.AddonSchema",this._isLoaded=!0,this._setAddonResources(e.schema.resources??[]))}),(0,A.map)(()=>this._schema),(0,A.share)()),this._schema$)}save(){return this._isLoaded?this._apiService.saveAddon(this._schema).pipe((0,A.map)(e=>e.success),(0,A.tap)(()=>{this._isChanged=!1})):(0,l.of)(!0)}clone(){return new Se(this)}equal(e){let t=this._isLoaded===e._isLoaded&&e.targetSchemaUId===this.targetSchemaUId&&e.addonName===this.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName;return t&&this._isLoaded&&(t=this._schema.equal(e._schema)),t}createOrUpdateResource(e){const t=this.resources.findIndex(s=>s.key===e.key);t===-1?this.resources.push(e):this.resources.splice(t,1,e),this._schema.resources=[...this._resources]}removeResource(e){const t=this.resources.findIndex(s=>s.key===e);this.resources.splice(t,1),this._schema.resources=[...this._resources]}}class oe{constructor(e){this._httpClient=e,this._workplaceServiceUrl="/rest/WorkplaceService/"}resetWorkplaceScriptCache(){const e=this._workplaceServiceUrl+"ResetScriptCache";return this._httpClient.post(e,null)}static{this.\u0275fac=function(t){return new(t||oe)(u.\u0275\u0275inject(x.HttpClient))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:oe,factory:oe.\u0275fac,providedIn:"root"})}}class Y{constructor(e){this.getAddonMethodName="GetSchema",this.getAddonMetadataMethodName="GetSchemaMetadata",this.saveAddonMethodName="SaveSchema",this.serviceEndpoint="/ServiceModel/AddonSchemaDesignerService.svc/",this._httpClient=e.get(x.HttpClient),this._workplaceService=e.get(oe)}getAddon(e){const t=`${this.serviceEndpoint}${this.getAddonMethodName}`;return this._httpClient.post(t,e)}getAddonMetadata(e){const t=`${this.serviceEndpoint}${this.getAddonMetadataMethodName}`;return this._httpClient.post(t,e)}saveAddon(e){const t=`${this.serviceEndpoint}${this.saveAddonMethodName}`;return this._httpClient.post(t,e).pipe((0,l.switchMap)(s=>this._workplaceService.resetWorkplaceScriptCache().pipe((0,A.map)(()=>s))))}static{this.\u0275fac=function(t){return new(t||Y)(u.\u0275\u0275inject(u.Injector))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:Y,factory:Y.\u0275fac})}}class q{constructor(e){this._apiService=e.get(Y),this._features=e.get(ae.G,{optional:!0})}_getParentSchemaUId(e){const t=e.parentSchema??e.parent;return t?.name===e.name?t.uId:v.To}create(e,t){return!e.addonTypes||e.addonTypes.length===0?[]:e.addonTypes.map(s=>{const i=this._getParentSchemaUId(e);return this.createAddonInfo(e,s,i,t)})}createAddonInfo(e,t,s,i){return new Se(t,e.uId,s,e.package.uId,i,this._apiService,e.useFullHierarchy)}static{this.\u0275fac=function(t){return new(t||q)(u.\u0275\u0275inject(u.Injector))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac})}}const Ls=a=>`/ServiceModel/${a}/`,ws=(a,e)=>({multi:!1,provide:e,useValue:Ls(a)}),Hs=a=>ws(a,Wt);class re extends y.t{get converter(){return this._converter}constructor(e){super(),this._restErrorHandleOptions={},this.createNewSchemaMethodName="CreateNewSchema",this.getSchemaMethodName="GetSchema",this.saveSchemaMethodName="SaveSchema",this.serviceEndpoint=e.get(Wt),this._converter=e.get(Kt,null,{optional:!0}),this._addonInfoFactory=e.get(q),this._errorHandler=e.get(I.x),this._restErrorHandleOptions.skipUnsuccessfulResponse=e.get(Bt,!1,{optional:!0})}getSchemaManagerName(){return null}getSchemaFromService(e,t,s=!1){const i=s?{headers:new x.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(e,t,i).pipe((0,A.map)(n=>{if(n.schema){const o=this.getSchemaManagerName();return n.schema=this.convertToObject(n.schema),n.schema.addons=this._addonInfoFactory.create(n.schema,o),n}return n}),(0,A.share)())}getSchemasFromService(e,t,s=!1){const i=s?{headers:new x.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(e,t,i).pipe((0,A.map)(n=>{if(n.schemas){const o=this.getSchemaManagerName();return n.schemas.forEach((p,h)=>{n.schemas[h]=this.convertToObject(p),n.schemas[h].addons=this._addonInfoFactory.create(p,o)}),n}return n}),(0,A.share)())}createObject(e,t){return Object.assign(new e,t)}convertToObject(e){return this._converter.convertToSchema(e)}convertSchemaToDTO(e){return e}_addonSaveHandler(e){const t=e.save();return this._errorHandler.handleRequest(t,this._restErrorHandleOptions).pipe((0,A.catchError)(()=>(0,l.of)(!1)),(0,A.map)(s=>({message:`Addon ${e.addonName} was ${s?"successfully":"not"} saved!`,result:s})))}_saveAddons(e){return(0,l.forkJoin)(e.map(t=>this._addonSaveHandler(t))).pipe((0,A.map)(t=>{const s=t.filter(i=>!i.result).map(i=>i.message);return s.length>0?s:null}))}createSchema(e){const t=`${this.serviceEndpoint}${this.createNewSchemaMethodName}`;return this.getSchemaFromService(t,e)}getSchema(e){const t=`${this.serviceEndpoint}${this.getSchemaMethodName}`;return this.getSchemaFromService(t,e)}saveSchema(e,t=!1){t&&(e.useFullHierarchy=!0);const s=`${this.serviceEndpoint}${this.saveSchemaMethodName}`,i=e.addons?[...e.addons]:null,n=(0,_.omit)(e,["addons"]),o=this.httpClient.post(s,n);return this._errorHandler.handleRequest(o,this._restErrorHandleOptions).pipe((0,A.concatMap)(h=>{const g=i?.filter(m=>m.isChanged);return h.success&&g?.length>0?this._saveAddons(g).pipe((0,A.map)(m=>({...h,addonsErrors:m}))):(0,l.of)(h)}),(0,A.share)())}checkUniqueSchemaName(e,t,s){const i=this.serviceEndpoint+"CheckUniqueSchemaName",n={schemaName:e,excludeUId:t,managerName:s};return this.httpClient.post(i,n,{headers:new x.HttpHeaders({"Content-Type":"application/json"})}).pipe((0,A.share)())}static{this.\u0275fac=function(t){return new(t||re)(u.\u0275\u0275inject(u.Injector))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:re,factory:re.\u0275fac,providedIn:"root"})}}class Jt{copy(e){return{...e}}isEmpty(e){return!1}}var ve=r(78868);class ce{constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BaseBusinessRuleDesignCondition",e?this.uId=e?.uId:this.uId=(0,v.qv)()}toMetadata(){return{typeName:this.typeName,uId:this.uId}}copy(){return new ce({...this.toMetadata(),uId:(0,v.qv)()})}isValid(){return!!this.uId}onDataSourceAttributeNameChanged(e,t,s){}isAttributeUsed(e,t){return!1}getWarningMessages(){return[]}}class Ie extends ce{}var Os=r(7748),$e=r(6553),Ue;(function(a){a[a.None=0]="None",a[a.And=1]="And",a[a.Or=2]="Or"})(Ue||(Ue={}));var E=r(86464),$;(function(a){a[a.IsNull=0]="IsNull",a[a.IsNotNull=1]="IsNotNull",a[a.Equal=2]="Equal",a[a.NotEqual=3]="NotEqual",a[a.Contain=11]="Contain",a[a.NotContain=12]="NotContain"})($||($={}));var ee=r(47149),js=r(16091),Xt=r(67706);class Ae extends ce{constructor(e){super(e),this._businessRuleDesignExpressionFactory=new js.T,this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BusinessRuleCondition",this.comparisonType=$.IsNull,e&&(e.leftExpression&&(this.leftExpression=this._businessRuleDesignExpressionFactory.get(e.leftExpression)),e.rightExpression&&(this.rightExpression=this._businessRuleDesignExpressionFactory.get(e.rightExpression)),e.comparisonType!=null&&(this.comparisonType=e.comparisonType))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),comparisonType:this.comparisonType}}copy(){const e=new Ae({...this.toMetadata(),uId:(0,v.qv)()});return e.leftExpression=this.leftExpression?.copy(),e.rightExpression=this.rightExpression?.copy(),e}isValid(){if(!super.isValid()||this.comparisonType==null)return!1;const e=!!this.leftExpression?.isValid();switch(this.comparisonType){case $.IsNull:case $.IsNotNull:return e;case $.Equal:case $.NotEqual:return e&&!!this.rightExpression?.isValid();default:return!0}}onDataSourceAttributeNameChanged(e,t,s){this.leftExpression.onDataSourceAttributeNameChanged(e,t,s),this.rightExpression?.onDataSourceAttributeNameChanged(e,t,s)}_getAttributeExpressionWarningMessage(e){if(!e.dataValueTypeName)return null;const t=Object.values(ee.Q).find(s=>s.name===e.dataValueTypeName)?.type;return t===E.r.MAXSIZE_TEXT?{message:"BusinessRules.Errors.MaxSizeInConditionLimitedWarningMessage",type:"warn"}:t===E.r.RICH_TEXT||t===E.r.Image?{message:"BusinessRules.Errors.NotSupportedInConditionTypesWarningMessage",type:"error"}:null}getWarningMessages(){const e=[];if(this.comparisonType===$.Equal||this.comparisonType===$.NotEqual){if(this.leftExpression instanceof Xt.b){const t=this._getAttributeExpressionWarningMessage(this.leftExpression);t&&e.push(t)}if(this.rightExpression instanceof Xt.b){const t=this._getAttributeExpressionWarningMessage(this.rightExpression);t&&e.push(t)}}return e}isAttributeUsed(e,t){return this.leftExpression?.isAttributeUsed(e,t)||this.rightExpression?.isAttributeUsed(e,t)}}class Me extends ce{constructor(e){super(e),this.typeName=$e.W,this.logicalOperation=Ue.And,this.conditions=[],e&&(this.logicalOperation=e.logicalOperation,this.conditions=e.conditions?.map(t=>t.typeName===$e.W?new Me(t):new Ae(t))??[])}_copyConditions(){return this.conditions.map(e=>e.copy())}toMetadata(){return{...super.toMetadata(),logicalOperation:this.logicalOperation,conditions:this.conditions.map(e=>e.toMetadata())}}copy(){const e=new Me({...this.toMetadata(),uId:(0,v.qv)()});return e.conditions=this._copyConditions(),e}isValid(){return super.isValid()&&this.conditions?this.conditions.length===0?!0:this.conditions.every(t=>t.isValid()):!1}onDataSourceAttributeNameChanged(e,t,s){this.conditions.forEach(i=>i.onDataSourceAttributeNameChanged(e,t,s))}isAttributeUsed(e,t){return this.conditions.some(s=>s.isAttributeUsed(e,t))}getWarningMessages(){return this.conditions.map(e=>e.getWarningMessages()).flat()}}class ks{get(e){return e.typeName===$e.W?new Me(e):new Ae(e)}}class xe{get actions(){return Object.freeze(this._actions)}constructor(e){this._businessRuleDesignActionFactory=new Os.J,this._businessRuleDesignConditionFactory=new ks,this._typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleCase",this._actions=[],this.uId=e?.uId||(0,v.qv)(),e?.condition?this.condition=this._businessRuleDesignConditionFactory.get(e.condition):this.condition=new Ie,e?.actions?.forEach(t=>{this._actions.push(this._businessRuleDesignActionFactory.get(t))})}_getActionIndex(e){return this.actions.findIndex(t=>t.uId===e.uId)}_actionsUpdateMetadata(e){const t=[];e.actions.forEach(i=>{t.push(i.uId);const n=this._businessRuleDesignActionFactory.get(i);this._getActionIndex(n)!==-1?this.updateAction(n):this.addAction(n)}),this.actions.filter(i=>!t.includes(i.uId)).forEach(i=>this.deleteAction(i))}_getActionsMetadata(){return this.actions.map(e=>e.toMetadata())}_getConditionMetadata(){const e=this.condition;return e&&!(e instanceof Ie)?e.toMetadata():null}_copyActions(){return this.actions.map(e=>e.copy())}_setActions(e){this._actions=[...e]}_copyCondition(){const e=this.condition;return e&&!(e instanceof Ie)?e.copy():new Ie}toMetadata(){const e=this._getConditionMetadata(),t=this._getActionsMetadata();return{typeName:this._typeName,uId:this.uId,condition:e,actions:t}}updateFromMetadata(e){e.condition&&this.updateCondition(this._businessRuleDesignConditionFactory.get(e.condition)),this._actionsUpdateMetadata(e)}addAction(e){if(this._getActionIndex(e)!==-1){console.warn(`Action ${e.uId} already exists`);return}this._actions=[...this._actions,e.clone()]}updateAction(e){const t=this._getActionIndex(e);if(t===-1){console.warn(`Action ${e.uId} not found`);return}this._actions=[...this._actions],this._actions.splice(t,1,e.clone())}deleteAction(e){const t=this._getActionIndex(e);t<0||(this._actions=[...this._actions],this._actions.splice(t,1))}updateCondition(e){this.condition=e}copy(){const e=new xe({...this.toMetadata(),uId:(0,v.qv)()});return e._setActions(this._copyActions()),e.condition=this._copyCondition(),e}onDataSourceAttributeNameChanged(e,t,s){this.condition.onDataSourceAttributeNameChanged(e,t,s),this._actions.forEach(i=>i.onDataSourceAttributeNameChanged(e,t,s))}isAttributeUsed(e,t){return this.condition.isAttributeUsed(e,t)||this._actions.some(s=>s.isAttributeUsed(e,t))}}var zs=r(92499);function Gs(a,e){return Object.values(a).indexOf(e)}class Pe{constructor(e){this._typeName="Terrasoft.Core.BusinessRules.Models.Trigger",this.name="",this.type=ve.T.ChangeAttributeValue,this.scopeId="",this.uId=e?.uId||(0,v.qv)(),e&&(this.name=e.name,this.type=Object.values(ve.T)[e.type||0],this.scopeId=e.scopeId)}toMetadata(){const e=Gs(ve.T,this.type);return{typeName:this._typeName,uId:this.uId,name:this.name,type:e,scopeId:this.scopeId}}copy(){return new Pe({...this.toMetadata(),uId:(0,v.qv)()})}isAttributeUsed(e,t){return this.name===t&&(0,zs.t4)(this.scopeId,e)}}class Ee{get hasWarnings(){return this.getWarningMessages().length>0}constructor(e,t,s,i,n){this.caption=t,this.schemaName=s,this.schemaCaption=i,this.applicabilityType=n,this._typeName="Terrasoft.Core.BusinessRules.BusinessRule",this.name="",this.enabled=!0,this.triggers=[],this.cases=[],this.needToSave=!1,this.parentUId="",this.parentActionUId="",this.uId=e.uId,this.updateFromMetadata(e)}_updateCase(e){const t=this.cases.find(s=>s.uId===e.uId);if(t){t.updateFromMetadata(e);return}this.addCase(new xe(e))}_casesUpdateMetadata(e){const t=[];e.cases?.forEach(s=>{t.push(s.uId),this._updateCase(s)}),this.cases=this.cases.filter(s=>t.includes(s.uId))}_copyCases(){return this.cases?.map(e=>e.copy())}_copyTriggers(){return this.triggers?.map(e=>e.copy())}_isValidCaption(){return this.caption.some(e=>e.value)}addTrigger(e,t,s=""){const i=Object.values(ve.T).indexOf(t),n=new Pe({name:e,type:i,scopeId:s});return this.triggers.push(n),n.uId}addCase(e){this.cases.push(e)}getFirstCase(){let e=this.cases[0];return e||(e=new xe,this.addCase(e),this.getFirstCase())}updateFromMetadata(e){this.parentUId=e.parentUId??"",this.parentActionUId=e.parentActionUId??"",this.name=e.name,this.enabled=e.enabled,this._casesUpdateMetadata(e),this.triggers=e.triggers?.map(t=>new Pe(t))??[]}toMetadata(){const e={typeName:this._typeName,uId:this.uId,cases:this.cases.map(t=>t.toMetadata()),triggers:this.triggers.map(t=>t.toMetadata()),name:this.name,enabled:this.enabled};return this.parentUId&&(e.parentUId=this.parentUId),this.parentActionUId&&(e.parentActionUId=this.parentActionUId),e}clone(){const e=new Ee(this.toMetadata(),this.caption.clone(),this.schemaName,this.schemaCaption,this.applicabilityType);return e.needToSave=this.needToSave,e}copy(){const e=this.caption.clone();e.forEach(s=>{s.value&&(s.value=`Copy ${s.value}`)});const t=new Ee({...this.toMetadata(),uId:(0,v.qv)()},e,this.schemaName,this.schemaCaption,this.applicabilityType);return t.name=Qt(),t.cases=this._copyCases(),t.triggers=this._copyTriggers(),t}isValid(){if(!this._isValidCaption())return!1;const t=this.getFirstCase(),s=t?.condition,i=t?.actions;return s?.isValid()&&i?.length>0&&i.every(n=>n.isValid())}showInvalid(){return this.needToSave?!this.isValid():!1}onDataSourceAttributeNameChanged(e,t,s){this.cases.forEach(i=>i.onDataSourceAttributeNameChanged(e,t,s))}getWarningMessages(){const e=[],s=this.getFirstCase()?.condition;return s&&e.push(...s.getWarningMessages()),e}isAttributeUsed(e,t){return this.cases.some(s=>s.isAttributeUsed(e,t))||this.triggers.some(s=>s.isAttributeUsed(e,t))}}var b=r(50588);class Bs extends Jt{copy(e){const t=e.metadata,s=[],i=[];return t.rules.forEach(n=>{const o=new Ee(n,new b.h,null,null,null),{uId:p,name:h}=o,g=o.copy();g.name=h;const m=g.uId,N=(e.resources||[]).find(Z=>Z.key?.includes(p));if(N){const Z=N.key.replace(p,m);i.push({...N,key:Z})}s.push(g.toMetadata())}),{metadata:{...e.metadata,rules:s},name:e.name,resources:i}}isEmpty(e){return!e.metadata?.rules||e.metadata.rules?.length===0}}class le{create(e){return e===ye.BusinessRule?new Bs:new Jt}static{this.\u0275fac=function(t){return new(t||le)}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:le,factory:le.\u0275fac})}}class te{static{this.\u0275fac=function(t){return new(t||te)}}static{this.\u0275mod=u.\u0275\u0275defineNgModule({type:te})}static{this.\u0275inj=u.\u0275\u0275defineInjector({providers:[Y,q,le],imports:[T.CommonModule]})}}(function(){(typeof ngJitMode>"u"||ngJitMode)&&u.\u0275\u0275setNgModuleScope(te,{imports:[T.CommonModule]})})();var se=r(23092),Ws=r(82898),Zt=r(49973),Ks=r(34251),Qs=r(36592),Yt=r(65751);class de{constructor(e){this._httpClient=e,this._appPackagesServiceUrl="ServiceModel/ApplicationPackagesService.svc/",this._getDesignPackageUId="GetDesignPackageUId"}getDesignPackageUId(e,t){const s=`${this._appPackagesServiceUrl}${this._getDesignPackageUId}`;return this._httpClient.post(s,{schemaUId:e,userLevelSchema:t})}static{this.\u0275fac=function(t){return new(t||de)(u.\u0275\u0275inject(x.HttpClient))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:de,factory:de.\u0275fac,providedIn:"root"})}}class be{constructor(e,t){this.name=e,this.uId=t}equal(e){return e==null?!1:this.uId===e.uId&&this.name===e.name&&this.type===e.type&&this.isChanged===e.isChanged&&this.isLocked===e.isLocked}clone(){const e=new be(this.name,this.uId);return e.type=this.type,e.isChanged=this.isChanged,e.isLocked=this.isLocked,e}}class ue extends Array{constructor(e){super(),e&&Array.isArray(e)&&(this.push(...e.map(t=>t.clone())),this.uId=e.uId),this.uId=this.uId||(0,v.qv)()}deleteItemByUId(e){const t=this.findItemIndex(e);return t<0?!1:(this.splice(t,1),!0)}findItemIndex(e){return this.findIndex(t=>t.uId===e)}findItem(e){return this.find(t=>t.uId===e)}addItem(e){this.unshift(e)}reloadAll(e){this.splice(0,this.length,...e||[])}equal(e){return e==null||this.length!==e?.length?!1:this.every(t=>{const s=e?.findItem(t.uId);return t.equal(s)})}clone(){return new ue(this)}getLocalizableValues(e,t){this.forEach(s=>{const i={};s.getLocalizableValues(i),Object.entries(i).forEach(([n,o])=>{e[`${t}.${s.name}.${n}`]=o})})}loadLocalizableValues(e,t,s=!1){const i={};Object.entries(e).map(([n,o])=>{const p=n.split("."),h=p.shift(),g=p.shift(),m=p.join(".");return{itemGroupName:h,itemName:g,itemResourceName:m,values:o}}).filter(({itemGroupName:n})=>n===t).forEach(({itemName:n,itemResourceName:o,values:p})=>{const h=i[n]??{};h[o]=p,i[n]=h}),Object.entries(i).forEach(([n,o])=>{this.find(h=>h.name===n).loadLocalizableValues(o,s)})}}class he{constructor(e){e&&(this.uId=e.uId,this.name=e.name,this.parentSchemaUId=e.parentSchemaUId),this.uId=this.uId||(0,v.qv)()}update(e){this.uId=e.uId,this.name=e.name}equal(e){if(e==null)return!1;let t=this.uId===e.uId&&this.name===e.name;return(this.parentSchemaUId||e.parentSchemaUId)&&(t=t&&this.parentSchemaUId===e.parentSchemaUId),t}clone(){return new he(this)}getLocalizableValues(e){}loadLocalizableValues(e,t=!1){}}class Le extends he{constructor(e){super(e),this.values=new b.h(e?.values)}clone(){return new Le(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.values=this.values.clone()}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.values.setValues(e.values,t)}}class Js{constructor(e){this.factory=e}createSchema(e){const t=new this.factory;return Object.assign(t,e),e.package&&(t.package=new be(e.package.name,e.package.uId),t.package.type=e.package.type,t.package.isChanged=e.package.isChanged,t.package.isLocked=e.package.isLocked),t}createLocalizableStrings(e){if(!e)return new ue;const t=e.map(s=>new Le(s));return new ue(t)}}var qt=r(44462);class Xs extends he{constructor(e){if(super(e),this.isReadOnly=!1,this.useFullHierarchy=!1,this.addonTypes=[],this.addons=[],e){if(this.id=e.id,e.package){const t=e.package;t.clone?this.package=t.clone():(this.package=new be(t.name,t.uId),this.package.type=t.type,this.package.isChanged=t.isChanged,this.package.isLocked=t.isLocked)}if(this.body=e.body,this.isReadOnly=e.isReadOnly,this.useFullHierarchy=e.useFullHierarchy,this.parentSchema=e.parentSchema,this.extendParent=e.extendParent,e.dependencies){const t=e.dependencies;let s=t.requiredSchemas;s&&(s=[...s]);let i=t.requiredEntityColumns;i&&(i=i.map(n=>({entitySchemaName:n.entitySchemaName,columnPaths:[...n.columnPaths]}))),this.dependencies={requiredSchemas:s,requiredEntityColumns:i}}}}updateDescription(e){super.update(e),this.id=e.id,this.package=e.package}equal(e){if(e==null)return!1;let t=super.equal(e)&&this.id===e.id&&this.body===e.body&&this.isReadOnly===e.isReadOnly&&this.useFullHierarchy===e.useFullHierarchy;return(this.package||e.package)&&(t=t&&this.package?.equal(e.package)),t}getLocalizableValues(e){super.getLocalizableValues(e)}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t)}}class we extends Xs{constructor(e){super(e),this.caption=new b.h,this.localizableStrings=new ue,this.description=new b.h,e&&(this.caption=e.caption?e.caption.clone():e.caption,this.description=e.description?e.description.clone():e.description,this.localizableStrings=e.localizableStrings?e.localizableStrings.clone():e.localizableStrings)}get DefaultName(){return"BaseSchema"}findChildrenItem(e){return this.localizableStrings.findItem(e)}findGroup(e){return this.localizableStrings.uId===e?this.localizableStrings:null}updateDescription(e){super.updateDescription(e),this.caption=new b.h(e.caption),this.description=new b.h(e.description)}equal(e){return e==null?!1:super.equal(e)&&(0,qt.$n)(this.caption,e.caption,!0)&&(0,qt.$n)(this.description,e.description,!0)}clone(){return new we(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),e.description=this.description.clone(),this.localizableStrings.getLocalizableValues(e,"localizableStrings")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.description.setValues(e.description,t),this.localizableStrings.loadLocalizableValues(e,"localizableStrings",t)}getIsOwnMetaItem(e){return this.uId===e.parentSchemaUId}}class es extends we{}class Zs{constructor(){this.caption=new b.h,this.description=new b.h}}class Ys extends he{constructor(){super(...arguments),this.caption=new b.h}}var qs=r(57852);class W extends Js{constructor(e,t){super(es),this._userInfo=e,this._resourceFinderService=t,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(e,t){return t.actions?.map(s=>({Id:s.uid,Code:s.name,Intent:{value:e},ActionType:s.actionSchemaTypeUId,Name:this._resourceFinderService.findLocalizableValue(s.caption),Description:this._resourceFinderService.findLocalizableValue(s.description),Params:s.params,PackageUId:t.package.uId}))}_convertSchemaParametersToDto(e,t,s){return t.map(i=>({UId:i.uId,Intent:{value:e},Name:this._resourceFinderService.findLocalizableValue(i.caption),Code:i.name,Description:i.description,SourceCollection:s,DataValueTypeUId:i.dataValueTypeUId}))}_convertDtoActionToSchema(e,t){const s=e.actions||[],n=t.filter(h=>s.every(g=>g.uid!==h.Id)).map(h=>{const g=new Zs;return g.uid=h.Id,g.name=h.Code,g.params=h.Params,g.actionSchemaTypeUId=h.ActionType,g.caption.setValueLocalizableString(this._sysCultureName,h.Name),g.description.setValueLocalizableString(this._sysCultureName,h.Description),g}),p=s.filter(h=>t.some(g=>g.Id===h.uid)).map(h=>{const g=t.find(m=>m.Id===h.uid);return h.name=g.Code,h.caption.setValueLocalizableString(this._sysCultureName,g.Name),h.description.setValueLocalizableString(this._sysCultureName,g.Description),h.params=g.Params,h.actionSchemaTypeUId=g.ActionType,h});e.actions=[...n,...p]}_convertDtoParametersToSchema(e,t,s){const i=e[t]||[],o=s.filter(g=>i.every(m=>m.uId!==g.UId)).map(g=>{const m=new Ys;return m.uId=g.UId,m.name=g.Code,m.caption.setValueLocalizableString(this._sysCultureName,g.Name),m.description=g.Description,m.dataValueTypeUId=g.DataValueTypeUId,m}),h=i.filter(g=>s.some(m=>m.UId===g.uId)).map(g=>{const m=s.find(N=>N.UId===g.uId);return g.name=m.Code,g.caption.setValueLocalizableString(this._sysCultureName,m.Name),g.description=m.Description,g.dataValueTypeUId=m.DataValueTypeUId,g});e[t]=[...o,...h]}_mapActions(e){return e?.map(t=>(t.description=new b.h(t.description),t.caption=new b.h(t.caption),t))}_mapParameters(e){return e?.map(t=>(t.caption=new b.h(t.caption),t))}_convertDtoSubIntentsToSchema(e,t){const s=e.subIntents||[],n=t.filter(h=>s.every(g=>g.uId!==h.UId)).map(h=>{const g=new es;return g.uId=h.UId,g.name=h.Code,g.description.setValueLocalizableString(this._sysCultureName,h.Description),g.caption.setValueLocalizableString(this._sysCultureName,h.Title),g}),p=s.filter(h=>t.some(g=>g.UId===h.uId)).map(h=>{const g=t.find(m=>m.UId===h.uId);return h.name=g.Code,h.description.setValueLocalizableString(this._sysCultureName,g.Description),h.caption.setValueLocalizableString(this._sysCultureName,g.Title),h});e.subIntents=[...n,...p]}_mapSubIntents(e){return e?.map(t=>(t.caption=new b.h(t.caption),t.description=new b.h(t.description),t))}_convertSchemaSubIntentsToDto(e){return e.subIntents?.map(t=>this.schemaToModel(t.uId,t))??[]}createSchema(e){const t=super.createSchema(e);return t.caption=new b.h(e.caption),t.description=new b.h(e.description),t.actions=this._mapActions(e.actions),t.inputParameters=this._mapParameters(e.inputParameters),t.outputParameters=this._mapParameters(e.outputParameters),t.subIntents=this._mapSubIntents(e.subIntents),t}convertToSchema(e){return this.createSchema(e)}mapModelToSchema(e,t){return e.prompt=t.Prompt,e.intentDescription=t.Description,e.caption.setValueLocalizableString(this._sysCultureName,t.Title),e.name=t.Code,e.status=t.Status,e.mode=t.Mode,e.type=t.Type,e.restrictions=t.Restrictions,e.roleDescription=t.RoleDescription,this._convertDtoParametersToSchema(e,"inputParameters",t.InputParameters??[]),this._convertDtoParametersToSchema(e,"outputParameters",t.OutputParameters??[]),this._convertDtoActionToSchema(e,t.Actions),this._convertDtoSubIntentsToSchema(e,t.SubIntents??[]),e}schemaToModel(e,t){return{UId:e,Title:this._resourceFinderService.findLocalizableValue(t.caption),Code:t.name,Description:t.intentDescription||this._resourceFinderService.findLocalizableValue(t.description),Prompt:t.prompt,Status:t.status,Type:t.type,Actions:this._convertSchemaActionToDto(e,t),ExtendParent:t.extendParent,PackageUId:t.package?.uId,Mode:t.mode,InputParameters:this._convertSchemaParametersToDto(e,t.inputParameters??[],"InputParameters"),OutputParameters:this._convertSchemaParametersToDto(e,t.outputParameters??[],"OutputParameters"),RoleDescription:t.roleDescription,Restrictions:t.restrictions,SubIntents:this._convertSchemaSubIntentsToDto(t)}}static{this.\u0275fac=function(t){return new(t||W)(u.\u0275\u0275inject(se.oq),u.\u0275\u0275inject(qs.Q))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:W,factory:W.\u0275fac})}}class K extends re{constructor(e){super(e)}static{this.\u0275fac=function(t){return new(t||K)(u.\u0275\u0275inject(u.Injector))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac})}}class pe extends Ks.${constructor(){super(),this._apiService=(0,u.inject)(K),this._convertor=(0,u.inject)(W),this._currentPackageService=(0,u.inject)(de),this._serverClientOperationNotificationReceiver=(0,u.inject)(Qs.k),this._queryExecutor=(0,u.inject)(Yt.w),this._copilotIntentChangedSubscribe()}_copilotIntentChangedSubscribe(){this._serverClientOperationNotificationReceiver.getNotifications("CopilotIntentChanged").subscribe(e=>this.setToCache(e.intentUId,this._getIntentSchema(e.intentUId)))}_normalizeUId(e){return e.toLocaleLowerCase()}_getIntentSchema(e){return this._apiService.getSchema({schemaUId:e,useFullHierarchy:!0}).pipe((0,l.map)(t=>{if(!t.success)throw new Error(t.errorInfo?.message||`Failed to get schema with UId: ${e}`);return t.schema}),(0,l.shareReplay)({bufferSize:1,refCount:!1}),(0,l.catchError)(t=>(0,l.throwError)(()=>t)))}setToCache(e,t){super.setToCache(this._normalizeUId(e),t)}getFromCache(e){return super.getFromCache(this._normalizeUId(e))}deleteFromCache(e){return super.deleteFromCache(this._normalizeUId(e))}get(e){let t=this.getFromCache(e);return t||(t=this._getIntentSchema(e),this.setToCache(e,t)),t.pipe((0,l.map)(s=>this._convertor.schemaToModel(e,s)))}getAllCodes(e){const t=new Zt.s(e);return t.addSchemaColumn("Code"),this._queryExecutor.executeSelectQuery(t).pipe((0,l.map)(s=>s.map(i=>String(i.Code))))}update(e){return this.getFromCache(e.UId).pipe((0,l.map)(t=>this._convertor.mapModelToSchema(t,e)),(0,l.switchMap)(t=>this._apiService.saveSchema(t)),(0,l.tap)(t=>{t.success||this.deleteFromCache(e.UId)}))}create(e){return this._currentPackageService.getDesignPackageUId(null).pipe((0,l.switchMap)(t=>this._apiService.createSchema({packageUId:t.uId,extendParent:!1,schemaUId:e})),(0,l.map)(t=>t.schema),(0,l.tap)(t=>this.setToCache(e,(0,l.of)(t))),(0,l.map)(t=>this._convertor.schemaToModel(e,t)))}static{this.\u0275fac=function(t){return new(t||pe)}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:pe,factory:pe.\u0275fac})}}let ge=class zt{static{this.\u0275fac=function(t){return new(t||zt)}}static{this.\u0275mod=u.\u0275\u0275defineNgModule({type:zt})}static{this.\u0275inj=u.\u0275\u0275defineInjector({providers:[{provide:Ws.p,useClass:pe},{provide:K,useFactory:e=>{const t=u.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:e,providers:[Hs("CopilotIntentSchemaDesignerService.svc"),{provide:Kt,useClass:W,deps:[se.oq]},{provide:Bt,useValue:!0}]});return new K(t)},deps:[u.Injector]},W],imports:[T.CommonModule,te]})}};ge=(0,c.__decorate)([(0,V.g)({})],ge),function(){(typeof ngJitMode>"u"||ngJitMode)&&u.\u0275\u0275setNgModuleScope(ge,{imports:[T.CommonModule,te]})}();var ei=r(86897),ti=r(15505),U=r(10661);class ie{static{this.\u0275fac=function(t){return new(t||ie)}}static{this.\u0275mod=u.\u0275\u0275defineNgModule({type:ie})}static{this.\u0275inj=u.\u0275\u0275defineInjector({providers:[ei.W,ti.D,U.R],imports:[T.CommonModule,S.TranslateModule]})}}(function(){(typeof ngJitMode>"u"||ngJitMode)&&u.\u0275\u0275setNgModuleScope(ie,{imports:[T.CommonModule,S.TranslateModule]})})();var He=r(22701),me=r(48594),L;(function(a){a.Assistant="assistant",a.User="user",a.System="system"})(L||(L={}));class Te{static get photo(){return"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTAsMTdhNSw1LDAsMCwwLDQuMS0yLjE0VjE2YS45LjksMCwwLDAsMS44LDBWOGEuOS45LDAsMCwwLTEuOCwwVjkuMTRBNSw1LDAsMSwwLDEwLDE3Wm0wLTEuOEEzLjIsMy4yLDAsMSwwLDYuOCwxMiwzLjIsMy4yLDAsMCwwLDEwLDE1LjJaIiBmaWxsPSIjMGQyZTRlIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48cGF0aCBkPSJNMTguOSw4YS45LjksMCwwLDAtMS44LDB2OGEuOS45LDAsMCwwLDEuOCwwWiIgZmlsbD0iIzBkMmU0ZSIvPjwvc3ZnPg"}static get title(){return"Creatio.ai"}static get contact(){return{photo:this.photo,name:this.title}}}class k{constructor(){this._fileMessageRegex=/#FileId\s+(\S+);.*?#FileName\s+([^;]+);/}_getAuthorByRole(e){return e.role!==L.Assistant?null:e.rootIntentCaption?{id:e.rootIntentId,name:e.rootIntentCaption}:Te.contact}_getIsBotMessage(e){return e===L.Assistant}_getMessageDirection(e){return e===L.User?me.Tt.Outcoming:me.Tt.Incoming}_getIsFileMessage(e){return e.role===L.System&&this._fileMessageRegex.test(e.content)}_getMessage(e,t){const s=e.createdOnTicks*1e-4;return{text:e.content,type:He.X.Text,date:new Date(s),id:e.id,author:this._getAuthorByRole(e),isBotMessage:this._getIsBotMessage(e.role),direction:this._getMessageDirection(e.role)}}_getFileMessage(e,t){const[,s,i]=e.content.match(this._fileMessageRegex);return{...this._getMessage(e,t),type:He.X.File,direction:me.Tt.Outcoming,text:"",attachments:[{fileId:s,fileName:i,fileType:me.Go.File,fileEntitySchemaName:"CreatioAISessionFile"}]}}_getIsSupportedMessage(e){return!(0,_.isEmpty)(e.content)&&(e.role===L.Assistant||e.role===L.User||e.isFileMessage)}convertMessages(e,t){return e.map(s=>({...s,isFileMessage:this._getIsFileMessage(s)})).filter(this._getIsSupportedMessage).map(s=>s.isFileMessage?this._getFileMessage(s,t):this._getMessage(s,t))}static{this.\u0275fac=function(t){return new(t||k)}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac})}}var d=r(73308),Ne=r(4164);let Oe=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var i=this;return(0,d.A)(function*(){const n=e.map(function(){var p=(0,d.A)(function*(h){return yield h[s]});return function(h){return p.apply(this,arguments)}}()),o=yield Promise.all(n);return(0,l.lastValueFrom)(i._intentSchemaManager.generateActionCode(o))})()}};Oe=(0,c.__decorate)([(0,Ne.a)({type:"crt.GenerateCopilotActionCode"}),(0,c.__metadata)("design:paramtypes",[U.R])],Oe);let je=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var i=this;return(0,d.A)(function*(){const n=e.map(function(){var p=(0,d.A)(function*(h){return yield h[s]});return function(h){return p.apply(this,arguments)}}()),o=yield Promise.all(n);return(0,l.lastValueFrom)(i._intentSchemaManager.generateSkillCode(o))})()}};je=(0,c.__decorate)([(0,Ne.a)({type:"crt.GenerateCopilotSkillCode"}),(0,c.__metadata)("design:paramtypes",[U.R])],je);let ke=class{convert(e,t,s){const[i,n]=e;return i||(s?!n:n)}};ke=(0,c.__decorate)([(0,Ne.a)({type:"crt.CopilotChatMode"})],ke);let ze=class{convert(e){return e?.map(s=>s).sort((s,i)=>{const n=typeof s.date=="string"?new Date(s.date):s.date,o=typeof i.date=="string"?new Date(i.date):i.date;return!n||!o?0:o.getTime()-n.getTime()})}};ze=(0,c.__decorate)([(0,Ne.a)({type:"crt.CopilotChatListConverter"})],ze);var Q=r(81517),F=r(2828),f=r(41287),C=r(844);let ts=class extends Q.S{};ts=(0,c.__decorate)([(0,F.$)({type:"crt.CodeChangeParameterListRequest",scopes:["AISkills_FormPage"]})],ts);let Ge=class extends f.l{constructor(){super(...arguments),this._windowCodeList="_copilotCodeList"}_extractKeys(e,t){return(0,d.A)(function*(){if(!e||e.length===0)return[];const s=e.map(function(){var i=(0,d.A)(function*(n){return yield n?.[t]});return function(n){return i.apply(this,arguments)}}());return Promise.all(s)})()}handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context,i=yield s?.InputParametersDetail,n=yield s?.OutputParametersDetail,o=[...yield t._extractKeys(i,"InputParametersDS_Code"),...yield t._extractKeys(n,"OutputParametersDS_Code")];if(o.length===0){yield t.next?.handle(e);return}window[t._windowCodeList]=o,yield t.next?.handle(e)})()}};Ge=(0,c.__decorate)([(0,C.l)({type:"crt.CodeChangeParameterListHandler",requestType:"crt.CodeChangeParameterListRequest",scopes:["AISkills_FormPage"]})],Ge);var Ce=r(59969),ss=r(18357),is=r(97398),ns=r(13161),fe=r(20555);class z{static{this.errorCodeGroups={AuthorizationError:["MissingApiKey","InvalidApiKey","Unauthorized","UnauthorizedClient","InvalidScope","InvalidGrantType"],FormatError:["InvalidRequest","InvalidJson","NoEntities"],LimitError:["RateLimitReached","InsufficientQuota","QuotaExceeded","InternalQuotaExceeded","LimitExceeded"],ServiceAvailabilityError:["ServiceUnavailable","ServerNotAvailable","EngineOverloaded","ServerError","RequestTimeout","NetworkError"],ExecutionError:["ActionExecutionFailed","InvalidResponse"],ConfigurationError:["InvalidUri","ModelNotFound","ModelError","IncorrectConfiguration"],UnknownError:["Unknown","UnknownError"]}}static{this.singleErrors=["CharacterLimitExceededError","ToolCallsInvokesLimitExceeded"]}static{this.errorCodeToGroup=z._populateErrorCodeToGroupMap()}static getErrorMessageKey(e){return z.singleErrors.includes(e)?`MessageEditor.ErrorCode.${e}`:`MessageEditor.ErrorCode.${z.errorCodeToGroup[e]||"UnknownError"}`}static _populateErrorCodeToGroupMap(){const e={};return Object.keys(z.errorCodeGroups).forEach(t=>{for(const s of z.errorCodeGroups[t])e[s]=t}),e}}var si=r(34268),ii=r.n(si);const ni={name:"uponSanitizeElement",func:(a,e)=>{if(e.tagName==="span"){const t=a.getAttribute("class"),s=a.getAttribute("data-mention");if(!(t==="mention"&&s)){const n=document.createTextNode(a.textContent||"");a.parentNode?.replaceChild(n,a)}}}};var G;(function(a){a.WaitingForUserMessage="WaitingForUserMessage",a.UserMessageQueued="UserMessageQueued",a.ExecutingAction="ExecutingAction",a.WaitingForAssistantMessage="WaitingForAssistantMessage",a.TitleUpdated="TitleUpdated"})(G||(G={}));var ai=r(5240),oi=r(72572);const as="CopilotMsgChannelSender",ri="CopilotChatPart",ci="CopilotSessionProgress";class R{constructor(e,t,s,i,n,o){this._userInfo=e,this._httpClient=t,this._translateService=s,this._messageChannelService=i,this.liveEditingService=n,this._featureValues=o,this._apiUrl="/rest/CopilotService",this._copilotSession=null,this._copilotSessionProgress$=new l.Subject,this._domPurifier=ii()(window);const p=this._featureValues??{};this._isNeedToAddConsoleLog=!!p.ShowSystemMessagesFromCopilot,this._domPurifier.addHook("uponSanitizeElement",ni.func)}mapSessions(e){return(!e.author?.id||e.author.id===v.To)&&(e.author=Te.contact),e.caption=e.caption||this._translateService.instant("Copilot.NewChatCaption"),e}getInitialMessages$(){return this._loadInitialMessages()}copilotSessionEvent$(e){return(0,l.merge)(this.copilotMessageEvent$().pipe((0,l.map)(t=>({lastMessage:e.convertMessages(t.messages,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})?.sort((i,n)=>n.date.getTime()-i.date.getTime())[0],sessionId:t.copilotSession?.id})),(0,l.filter)(t=>!!t.lastMessage),(0,l.map)(t=>({id:t.sessionId,date:t.lastMessage.date,preview:this._toPlainText(t.lastMessage.text),author:t.lastMessage.author}))),this.copilotSessionProgressEvent$().pipe((0,l.filter)(t=>t.state===G.TitleUpdated),(0,l.map)(t=>({id:t.copilotSessionId,caption:t.copilotSessionTitle}))))}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,l.filter)(e=>e.header.sender===as&&e.header.bodyTypeName===ri),(0,l.map)(e=>e.body),(0,l.tap)(e=>this._logCopilot(e)))}copilotSessionProgressEvent$(){return(0,l.merge)(this._copilotSessionProgressEvent$(),this._copilotSessionProgress$.asObservable()).pipe((0,l.tap)(e=>this._logCopilot(e)))}sessionUpdateEvent$(){return this.liveEditingService.liveEditingEvent$.pipe((0,l.filter)(e=>e.entitySchemaName==="CopilotSessionEnt"))}_copilotSessionProgressEvent$(){return this._messageChannelService.messageEvent$.pipe((0,l.filter)(e=>e.header.sender===as&&e.header.bodyTypeName===ci),(0,l.map)(e=>e.body))}_logCopilot(e){this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(e),console.groupEnd())}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,l.mergeMap)(e=>this._handleActiveCopilotSessions(e).pipe((0,l.catchError)(t=>(console.log(t),(0,l.of)([]))))))}_handleActiveCopilotSessions(e){return e.length>0?(this._copilotSession=e[0],this.getCopilotSessionMessages(this._copilotSession.id)):(0,l.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,l.map)(e=>e.copilotSessions))}_notifyCopilotSessionProgress(e){this._copilotSessionProgress$.next({copilotSessionId:this._copilotSession?.id,state:e})}_sendUserMessage(e,t=void 0,s={rootIntentIds:[]}){return(0,l.of)(G.UserMessageQueued).pipe((0,l.tap)(i=>this._notifyCopilotSessionProgress(i)),(0,l.switchMap)(()=>P.d.instance.getContext()),(0,l.switchMap)(i=>this._httpClient.post(`${this._apiUrl}/SendMessage`,{content:e,copilotContext:JSON.stringify(i||[]),copilotSessionId:t,options:s})),(0,l.map)(i=>i?.copilotChatPart),(0,l.catchError)(i=>(0,l.of)({errorCode:"unknown",errorMessage:`${i}`,copilotSession:this._copilotSession,messages:[]})),(0,l.tap)(i=>{(0,_.isEmpty)(i?.errorMessage)||this._notifyCopilotSessionProgress(G.WaitingForUserMessage)}))}_getMentionAgents(e){const t=document.createElement("div");return t.innerHTML=e,Array.from(t.querySelectorAll(".mention")).map(s=>s.getAttribute("data-mention")).filter(s=>!!s)}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,l.catchError)(e=>(0,l.throwError)(()=>new Error(`Server return status: ${e.status}`))))}_sanitizeContent(e){return this._domPurifier.sanitize(e,{ALLOWED_TAGS:["span"],ALLOWED_ATTR:["class","data-mention"]})}_toPlainText(e){if(!e)return"";const t=this._replaceMentions(e);return this._stripMarkdown(t)}_replaceMentions(e){if(!e.includes('class="mention"')&&!e.includes("class='mention'"))return e;const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll(".mention").forEach(s=>{const i=s.textContent||"";s.replaceWith(document.createTextNode(i))}),t.innerHTML}_stripMarkdown(e){return e.replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*(.*?)\*/g,"$1").replace(/__(.*?)__/g,"$1").replace(/_(.*?)_/g,"$1").replace(/`([^`]+?)`/g,"$1").replace(/^>+\s?/gm,"").replace(/^#{1,6}\s?/gm,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\\n/g,`
`).replace(/\n{2,}/g,`

`).trim()}sayWithResponse(e){return this.sayToSessionWithResponse(e,this._copilotSession?.id)}sayToSessionWithResponse(e,t){var s=this;return(0,d.A)(function*(){const n={rootIntentIds:s._getMentionAgents(e)},o=s._sanitizeContent(e),p=yield(0,l.firstValueFrom)(s._sendUserMessage(o,t,n));return p&&(0,_.isEmpty)(p.errorCode)&&(0,_.isEmpty)(p.errorMessage)&&(s._copilotSession=p.copilotSession),p})()}closeSession(){var e=this;return(0,d.A)(function*(){if(!e._copilotSession?.id)return Promise.reject("No active session");try{yield(0,l.firstValueFrom)(e._closeCopilotSession()),e._copilotSession=null}catch(t){return Promise.reject(`Server return status: ${t.status}`)}})()}getActiveSessionPreviewById(e){return this._httpClient.get(`${this._apiUrl}/GetActiveSessionPreviewById/${e}`).pipe((0,l.map)(t=>({...t,author:{id:t.author.id,name:t.author?.caption||t.author?.name},preview:this._toPlainText(t.preview)})))}getActiveSessionsWithPreview(e=0,t=15){return this._httpClient.get(`${this._apiUrl}/GetSessionsPageWithPreview/${e}/${t}`).pipe((0,l.map)(s=>s.map(i=>({...i,author:{id:i.author?.id,name:i.author?.caption||i.author?.name},preview:this._toPlainText(i.preview)}))))}getCopilotSessionMessages(e){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:e}).pipe((0,l.map)(t=>t.copilotMessages))}static{this.\u0275fac=function(t){return new(t||R)(u.\u0275\u0275inject(se.oq),u.\u0275\u0275inject(x.HttpClient),u.\u0275\u0275inject(S.TranslateService),u.\u0275\u0275inject(ai.A),u.\u0275\u0275inject(oi.m),u.\u0275\u0275inject(ae.G,8))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:R,factory:R.\u0275fac,providedIn:"root"})}}var Be=r(6503);class J{constructor(e,t,s){this._copilotChatService=e,this._notifyService=t,this._translateService=s}getInitialMessages$(){return this._copilotChatService.getInitialMessages$()}copilotMessageEvent$(){return this._copilotChatService.copilotMessageEvent$()}copilotSessionProgressEvent$(){return this._copilotChatService.copilotSessionProgressEvent$()}closeSession(){return this._copilotChatService.closeSession()}_getCurrentUserTime(){return new Date().getTime()*1e4+621355968e9}_sendErrorMessageToChat(e,t){var s=this;return(0,d.A)(function*(){if(!e)return;const i=z.getErrorMessageKey(t??""),n={id:(0,v.qv)(),createdOnTicks:s._getCurrentUserTime(),content:s._translateService.instant(i),role:L.Assistant,isSaved:!0};e?.messages?.push(n)})()}_notifyUser(e){var t=this;return(0,d.A)(function*(){const s=z.getErrorMessageKey(e??"");yield t._notifyService.error({message:s})})()}sayWithResponse(e){var t=this;return(0,d.A)(function*(){let s;try{s=yield t._copilotChatService.sayWithResponse(e);const i=s?.errorCode;return i&&(yield t._sendErrorMessageToChat(s,i),yield t._notifyUser(i)),s}catch(i){yield t._notifyUser(),console.error(i)}})()}sayToSessionWithResponse(e,t){var s=this;return(0,d.A)(function*(){let i;try{i=yield s._copilotChatService.sayToSessionWithResponse(e,t);const n=i?.errorCode;return n&&(yield s._sendErrorMessageToChat(i,n),yield s._notifyUser(n)),i}catch(n){yield s._notifyUser(),console.error(n)}})()}static{this.\u0275fac=function(t){return new(t||J)(u.\u0275\u0275inject(R),u.\u0275\u0275inject(Be.F),u.\u0275\u0275inject(S.TranslateService))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:J,factory:J.\u0275fac,providedIn:"root"})}}class li extends f.l{constructor(e){super(),this._sidebarStateService=e.get(is.p),this._copilotChatService=e.get(J),this._profileService=e.get(ss.c),this._customEventService=e.get(Ce.Dj)}_getChatPanelProfileData(){var e=this;return(0,d.A)(function*(){return yield(0,l.firstValueFrom)(e._profileService.getProfile(ns.j))})()}_getChatSessionId(){var e=this;return(0,d.A)(function*(){const t=yield e._getChatPanelProfileData(),s=yield(0,l.firstValueFrom)(e._sidebarStateService.opened.rootSidebar$);return t&&!t.isChatsListVisible&&s===fe.b?t.lastChatId:null})()}handle(e){var t=this;return(0,d.A)(function*(){const s=e;let i;s.useCurrentSession?(e.$context.CurrentCopilotSessionId=(yield e.$context.CurrentCopilotSessionId)??(0,v.qv)(),i=yield e.$context.CurrentCopilotSessionId):i=yield t._getChatSessionId(),yield t._sidebarStateService.openRootSidebar(fe.b);const n=yield t._copilotChatService.sayToSessionWithResponse(s.prompt,i);return!i&&n?.copilotSession&&t._customEventService.createOutboundChannel(fe.k).next(n.copilotSession.id),n})()}}let We=class extends li{constructor(e){super(e)}handle(e){var t=()=>super.handle,s=this;return(0,d.A)(function*(){yield t().call(s,e),yield s.next?.handle(e)})()}};We=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotActionRequestHandler",requestType:"crt.CopilotActionRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],We);const os="CopilotChatInitMessagesSubscriptions",rs="NavigationStateIsLoading",Ke="CurrentPageSchemaName",cs="CopilotIntents",ls="CopilotIntentPageQuickLinks",di="CopilotQuickActions";class B{constructor(e){this._httpClient=e,this._executeIntentUrl="/rest/CopilotService/ExecuteIntent",this._getAvailableIntentsUrl="/rest/CopilotService/GetAvailableIntents"}_transformInputParameters(e){return e?Object.entries(e).map(([t,s])=>({Key:t,Value:s||""})):[]}_transformOutputParameters(e){return e?e.reduce((t,s)=>(t[s.Key]=s.Value,t),{}):null}_executeIntent(e,t,s){const i=this._transformInputParameters(s),n={intentName:e,additionalPromptText:t,parameters:i};return this._httpClient.post(this._executeIntentUrl,n).pipe((0,l.map)(o=>(o.isSuccess&&(o.resultParameters=this._transformOutputParameters(o.resultParameters)),o)),(0,A.catchError)(o=>(0,l.throwError)(()=>new Error(`Server return status: ${o.status}`))))}_getAvailableIntents(e,t){const s={names:e},i=this._getAvailableIntentsUrl+`/?mode=${t}`;return this._httpClient.post(i,s).pipe((0,A.catchError)(n=>(0,l.throwError)(()=>new Error(`Server return status: ${n.status}`))))}executeIntent(e,t,s){var i=this;return(0,d.A)(function*(){try{return yield(0,l.firstValueFrom)(i._executeIntent(e,t,s))}catch(n){const o=n.status?`Server return status: ${n.status}`:`${n}`;return Promise.reject(o)}})()}getAvailableIntents(e,t){var s=this;return(0,d.A)(function*(){t||(t="API");try{return yield(0,l.firstValueFrom)(s._getAvailableIntents(e,t))}catch(i){const n=i.status?`Server return status: ${i.status}`:`${i}`;return Promise.reject(n)}})()}static{this.\u0275fac=function(t){return new(t||B)(u.\u0275\u0275inject(x.HttpClient))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:B,factory:B.\u0275fac,providedIn:"root"})}}let Qe=class extends f.l{constructor(e){super(),this._watchAttributes=[Ke,cs,ls],this._runMode="Chat",this._copilotService=e.get(B)}_actualizeCopilotQuickActions(e){var t=this;return(0,d.A)(function*(){const s=yield e[di],i=(yield e[cs])??[],n=yield e[ls];if(!Array.isArray(i)||i.length===0||!Array.isArray(n)||n.length===0)return;yield s.clear();const o=yield e[Ke];let h=(yield Promise.all(n.map(function(){var m=(0,d.A)(function*(N){return{pageName:yield N.PageName,intentCode:yield N.IntentCode}});return function(N){return m.apply(this,arguments)}}()))).filter(m=>t._isPatternMatch(m.pageName,o)).map(m=>m.intentCode);h.length>0&&(h=(yield t._copilotService.getAvailableIntents(h,t._runMode))?.availableIntentNames??[]);const g=[];for(const m of i){const N=yield m.Code;t._hasMatchingPattern(h,N)&&g.push(m)}yield s.reload(g)})()}_hasMatchingPattern(e,t){return e.some(s=>this._isPatternMatch(s,t))}_isPatternMatch(e,t){t=`${t}`.trim().toLowerCase(),e=`${e}`.trim().toLowerCase();const[s]=e.split("*").filter(Boolean);return e==="*"?!0:e.startsWith("*")?t.endsWith(s):e.endsWith("*")?t.startsWith(s):e===t}handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context;if(t._watchAttributes.includes(e.attributeName))return yield t._actualizeCopilotQuickActions(s),t.next?.handle(e)})()}};Qe=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotActualizeIntentQuickLinksHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Qe);var D=r(91775),ds=r(40968);class _e{constructor(){this._pageChange$=new l.BehaviorSubject(void 0)}pageChangeEvent$(){return this._pageChange$.asObservable()}setPage(e){this._pageChange$.next(e)}static{this.\u0275fac=function(t){return new(t||_e)}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:_e,factory:_e.\u0275fac,providedIn:"root"})}}var ui=r(97842),hi=r(38641);let Je=class extends f.l{constructor(e,t,s,i,n,o){super(),this._copilotChatService=e,this._aiChatPageContextService=t,this._crtRouter=s,this._userInfo=i,this._injector=n,this._featureValues=o,this.userConsentService=n.get(j.F),this._copilotToChatConvertor=n.get(k)}_openNewConversation(e,t){return(0,d.A)(function*(){const s={type:"crt.CopilotNewChatRequest",scopes:t.scopes,$context:e};yield D.t.instance.process(s)})()}_openConversation(e,t){return(0,d.A)(function*(){const s={type:"crt.ChatSessionOpenRequest",session:{id:(yield e.CurrentCopilotSessionId)??v.To},scopes:t.scopes,$context:e};yield D.t.instance.process(s)})()}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_initUserConsentData(e){this.userConsentService.getConsent("CopilotLegalNotice").subscribe(t=>{t&&(e.CopilotDisclaimer=t.consentText,this.userConsentService.getUserConsent(t.id).subscribe(s=>{e.IsCopilotChatVisible=s!==null,e.IsCopilotDisclaimerVisible=s===null}))})}_initWatchNavigation(e){var t=this;return(0,d.A)(function*(){const s=t._crtRouter.navigateStart$.pipe((0,l.tap)(()=>e[rs]=!0)).subscribe(),i=t._crtRouter.navigateEnd$.pipe((0,l.tap)((0,d.A)(function*(){e[rs]=!1;const n=yield(0,l.firstValueFrom)(t._crtRouter.crtRoute$);(n?.state?.moduleName||n?.state?.schemaName)&&t._aiChatPageContextService.setPage(n?.state?.schemaName)}))).subscribe();t._aiChatPageContextService.pageChangeEvent$().subscribe(n=>{e[Ke]=n}),yield t._addToSubscriptions(e,[s,i])})()}_onSessionProgressEvent(e,t){return(0,d.A)(function*(){const s=e?.state;(yield t.CurrentCopilotSessionId)===e?.copilotSessionId&&s in G&&(t.IsTyping=s!==G.WaitingForUserMessage&&s!==G.TitleUpdated)})()}_onMessageEvent(e,t){var s=this;(0,d.A)(function*(){try{if(e.copilotSession?.id===(yield t.$context.CurrentCopilotSessionId)){const i=Array.isArray(yield t.$context.ChatMessages)?yield t.$context.ChatMessages:[];t.$context.ChatMessages=[...i,...s._getConvertedMessages(e.messages)]}}catch(i){console.error("Error processing messages:",i)}})()}_onActiveSessionEvent(e,t){var s=this;this._copilotChatService.getActiveSessionPreviewById(e.primaryColumnValue).subscribe(i=>{(0,d.A)(function*(){i=s._copilotChatService.mapSessions(i),s._updateCurrentSessionTitle(i,t);const n=yield t.$context.ActiveChats;t.$context.ActiveChats=[i,...n]})()})}_onActiveSessionLiveEvent(e,t){var s=this;(0,d.A)(function*(){try{if(e.id=!e.id||e.id===v.To?yield t.$context.CurrentCopilotSessionId:e.id,!e.id)return;e.caption&&s._updateCurrentSessionTitle(e,t),yield s._partiallyChatUpdate(e.id,t,i=>(i.caption=e.caption??i.caption,i.author=e.author??i.author,i.date=e.date??i.date,i.preview=e.preview??i.preview,s._copilotChatService.mapSessions(i)))}catch(i){console.error("Error updating chat session:",i)}})()}_partiallyChatUpdate(e,t,s){return(0,d.A)(function*(){const i=(yield t.$context.ActiveChats)?.findIndex(n=>n.id===e);if(i>=0){const n=s((yield t.$context.ActiveChats)[i]),o=yield t.$context.ActiveChats;o[i]=n,t.$context.ActiveChats=[...o]}})()}_updateCurrentSessionTitle(e,t){return(0,d.A)(function*(){e.id===(yield t.$context.CurrentCopilotSessionId)&&e.caption&&e.caption!==(yield t.$context.CurrentCopilotSessionTitle)&&(t.$context.CurrentCopilotSessionTitle=e.caption)})()}_addToSubscriptions(e,t){return(0,d.A)(function*(){const s=(yield e[os])??[];e[os]=s,s.push(...t)})()}_setFeatureAttributes(e){e.EnableChatFileHandling=this._featureValues["GenAIFeatures.UseChatFileHandling"]}_initChatsList(e,t){const s={type:"crt.CopilotChatListLoadRequest",rowsToLoadCount:15,isFirstLoad:!0,scopes:t,$context:e};return D.t.instance.process(s)}_loadProfile(e,t){const s={type:"crt.LoadChatProfileRequest",scopes:t,$context:e};return D.t.instance.process(s)}_initAttributes(e,t){t&&(e.CurrentCopilotSessionId=t.lastChatId,typeof t.isCombinedMode=="boolean"&&(e.IsCombinedMode=t.isCombinedMode),typeof t.isChatsListVisible=="boolean"&&(e.ChatsListVisible=t.isChatsListVisible),typeof t.combinedModeEnabled=="boolean"&&(e.CombinedModeEnabled=t.combinedModeEnabled))}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e);const s=e.$context;t._setFeatureAttributes(s);const i=yield t._loadProfile(s,e.scopes);yield(0,l.lastValueFrom)(t._copilotChatService.getInitialMessages$()),t._initAttributes(s,i);const n=t._copilotChatService.copilotSessionProgressEvent$().subscribe(p=>t._onSessionProgressEvent(p,e.$context)),o=t._copilotChatService.copilotMessageEvent$().subscribe(p=>{t._onMessageEvent(p,e)});t._copilotChatService.sessionUpdateEvent$().pipe((0,l.filter)(p=>p.eventType==="create")).subscribe(p=>{t._onActiveSessionEvent(p,e)}),t._copilotChatService.copilotSessionEvent$(t._copilotToChatConvertor).subscribe(p=>{t._onActiveSessionLiveEvent(p,e)}),yield t._initChatsList(s,e.scopes),yield t._addToSubscriptions(s,[n,o]),e.$context.CopilotContact=Te.contact,t._initUserConsentData(e.$context),((yield e.$context.IsConversationVisible)===!0||(0,_.isEmpty)(i))&&(i?.lastChatId?yield t._openConversation(e.$context,e):yield t._openNewConversation(e.$context,e)),yield t._initWatchNavigation(s)})()}};Je=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,c.__param)(5,(0,u.Inject)(ae.G)),(0,c.__param)(5,(0,ds.j)(ae.G)),(0,c.__metadata)("design:paramtypes",[R,_e,hi.f,se.oq,u.Injector,ui.x])],Je);let us=class extends Q.S{};us=(0,c.__decorate)([(0,F.$)({type:"crt.CopilotChatModeRequest"})],us);let Xe=class extends f.l{_handleConversationOpen(e,t){return(0,d.A)(function*(){if((yield e.ChatsListVisible)&&(yield e.IsCombinedMode)){const s={type:"crt.CopilotNewChatRequest",scopes:t.scopes,$context:e};yield D.t.instance.process(s)}})()}_saveProfile(e,t){return(0,d.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield D.t.instance.process(s)})()}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e);const s=e.$context;s.IsCombinedMode=e.isCombined,yield t._handleConversationOpen(s,e),t._saveProfile(s,e.scopes)})()}};Xe=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotChatModeHandler",requestType:"crt.CopilotChatModeRequest",scopes:["CopilotPanel"]})],Xe);var Re=r(48534),De=r(85040),hs=r(29957);let Ze=class extends f.l{constructor(e){super(),this._copilotPanelCode="Copilot",this._copilotToEditorCommunicationService=e.get(Re.i)}handle(e){var t=this;return(0,d.A)(function*(){e.sidebarCode===t._copilotPanelCode&&t._copilotToEditorCommunicationService.notify({editorAction:De.u.RemoveHighlighting,selection:hs.String.empty}),yield t.next?.handle(e)})()}};Ze=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotClosePanelHandler",requestType:"crt.HandleSidebarCloseRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Ze);var ps=r(82517),Ye=r(7471),gs=r(67354);let qe=class extends f.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(U.R),this._dialogService=this.injector.get(Ye.o),this._translateService=this.injector.get(S.TranslateService)}_refreshGrid(e){var t=this;return(0,d.A)(function*(){const s=e.$context,n={type:"crt.LoadDataRequest",scopes:e.scopes,config:{loadType:ps.I.Reload,useLastLoadParameters:!0},$context:s,dataSourceName:"ActionsDetailDS"};yield t.handlerChain.process(n)})()}handle(e){var t=this;return(0,d.A)(function*(){const s=t._translateService.instant("Copilot.DeleteRecordConfirmation");if((yield(0,l.firstValueFrom)(t._dialogService.openConfirmationDialog(s)))===gs.ch.result){const n=yield(0,l.firstValueFrom)(t._intentManager.deleteAction(e.intentId,e.recordId));if(!n.success)throw new Error(n.errorInfo?.message);yield t._refreshGrid(e)}})()}};qe=(0,c.__decorate)([(0,C.l)({requestType:"crt.DeleteActionFromIntentRequest",type:"crt.CopilotDeleteIntentActionHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],qe);let et=class extends Q.S{};et=(0,c.__decorate)([(0,F.$)({type:"crt.DeleteRecordRequest"})],et);var ms=r(49159),tt=r(85604);let Cs=class extends et{};Cs=(0,c.__decorate)([(0,F.$)({type:"crt.DeleteSubIntentRequest"})],Cs);let st=class extends f.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(U.R),this._dialogService=this.injector.get(Ye.o),this._translateService=this.injector.get(S.TranslateService)}handle(e){var t=this;return(0,d.A)(function*(){const s=t._translateService.instant("Copilot.DeleteRecordConfirmation");(yield(0,l.firstValueFrom)(t._dialogService.openConfirmationDialog(s)))===gs.ch.result&&(yield(0,l.firstValueFrom)(t._intentManager.deleteSubIntent(e.parentIntentId,e.recordId)),ms.q.instance.notify({modelId:(0,v.qv)(),dataSchemaName:"CopilotAgentSubSkill",type:tt.M.Delete,payload:{primaryAttributesValues:[[{name:"Id",value:e.recordId}]]}}))})()}};st=(0,c.__decorate)([(0,C.l)({requestType:"crt.DeleteSubIntentRequest",type:"crt.CopilotDeleteSubIntentHandler",scopes:["AIAgents_FormPage"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],st);let it=class extends f.l{constructor(e){super(),this._userConsentService=e.get(j.F)}handle(e){var t=this;return(0,d.A)(function*(){t._userConsentService.giveUserConsent(e.consentCode).subscribe(()=>{e.$context.IsCopilotChatVisible=!0,e.$context.IsCopilotDisclaimerVisible=!1}),yield t.next?.handle(e)})()}};it=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotDisclaimerAcceptHandler",requestType:"crt.CopilotDisclaimerAcceptRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],it);let nt=class extends f.l{constructor(e){super(),this._copilotService=e.get(B)}handle(e){var t=this;return(0,d.A)(function*(){const s=yield t._copilotService.executeIntent(e.intentName,e.additionalPromptText,e.parameters);return yield t.next?.handle(e),s})()}};nt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotExecuteIntentHandler",requestType:"crt.CopilotExecuteIntentRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],nt);let at=class extends f.l{constructor(e){super(),this._copilotService=e.get(B)}_isObjectResponse(e){return!!e&&e===Object(e)&&!Array.isArray(e)}handle(e){var t=this;return(0,d.A)(function*(){const s=yield t._copilotService.getAvailableIntents(e.intentNames,e.mode),i=yield t.next?.handle(e);return t._isObjectResponse(i)?{...s,...i}:s})()}};at=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotGetAvailableIntentsHandler",requestType:"crt.CopilotGetAvailableIntentsRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],at);var pi=r(92009);let ot=class extends f.l{constructor(e){super(),this._schemaService=e,this._defValueHandlers=new Map([["CopilotIntentParameter",this._handleCopilotIntentParameterDefValues],["SysSchemaOperationRight",this._handleSysSchemaOperationRightDefValues]])}_handleCopilotIntentParameterDefValues(e,t){const s=e.dataGridName.replace("Detail","");return t.push({attributeName:"SourceCollection",value:s}),t.push({attributeName:"DataValueTypeUId",value:ee.Q[E.r.MAXSIZE_TEXT].id}),Promise.resolve()}_handleSysSchemaOperationRightDefValues(e,t){return(0,d.A)(function*(){const s=yield e.$context.Id;t.push({attributeName:"SysSchemaUId",value:s}),t.push({attributeName:"Operation",value:7})})()}_getDataGridViewConfig(e){return this._schemaService.getViewConfigInfoByProperty("type","crt.DataGrid")?.map(t=>t?.viewConfig)?.find(t=>t?.name===e)??null}_getIsSupportedEntitySchemaName(e){return this._defValueHandlers.has(e)}handle(e){var t=this;return(0,d.A)(function*(){const{dataGridName:s,defaultValues:i}=e,n=e.$context,p=t._getDataGridViewConfig(s)?.items?.toString().slice(1);if(p){const g=n.getBoundDataSchemaByAttributePath(p).dataSourceConfig.config.entitySchemaName;if(!t._getIsSupportedEntitySchemaName(g))return t.next?.handle(e);yield t._defValueHandlers.get(g)(e,i)}return t.next?.handle(e)})()}};ot=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotIntentDetailCreateItemHandler",requestType:"crt.DataGridCreateItemRequest",scopes:["AISkills_FormPage"]}),(0,c.__metadata)("design:paramtypes",[pi.R])],ot);var fs=r(73743);let rt=class extends f.l{constructor(){super(...arguments),this._apiMode=fs.$E.get(fs.aA.Api)}handle(e){var t=this;return(0,d.A)(function*(){if(e.attributeName==="PDS_Mode"){const s=e.value?e.value:yield e.$context.PDS_Mode;e.$context.IsApiMode=s?s.value===t._apiMode:!1}return t.next?.handle(e)})()}};rt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotIntentModeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AISkills_FormPage"]})],rt);var gi=r(50237),mi=r(5704),Ci=r(29025),fi=r(53163),_s=r(38071);class ys extends f.l{constructor(e){super(),this._featureService=e.get(_s.d)}_initializeFeatureAttributes(e){var t=this;return(0,d.A)(function*(){const s=t.featureToAttributeMap;for(const i of s){const{featureCode:n,attributeName:o,invert:p}=i,h=yield(0,l.lastValueFrom)(t._featureService.getFeatureState(n));e[o]=p?!h:h}})()}_processPredefinedFilter(e,t){return(0,d.A)(function*(){const s=yield e[t.filterAttributeName],i=yield e[t.filterValueAttributeName];if(s){const n=gi.b.fromJson(s);n.filters.forEach(o=>{o instanceof mi.x&&o.leftExpression instanceof Ci.g&&o.leftExpression.columnPath===t.filterEntityColumnPath&&o.rightExpression instanceof fi.J&&(o.rightExpression.parameter.value=i,e[t.filterAttributeName]=n.toJson())})}})()}_initializePredefinedFilterValues(e){var t=this;return(0,d.A)(function*(){const s=t.predefinedFilterValueMap;for(const i of s)yield t._processPredefinedFilter(e,i)})()}handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context;yield t._initializeFeatureAttributes(s),yield t.next?.handle(e),yield t._initializePredefinedFilterValues(s)})()}}let ct=class extends ys{constructor(e){super(e),this._availableDataValueTypes=[E.r.Date,E.r.Time,E.r.DateTime,E.r.Guid,E.r.Boolean,E.r.LONG_TEXT,E.r.MAXSIZE_TEXT,E.r.Integer,E.r.FLOAT2,E.r.Money],this._translateService=e.get(S.TranslateService)}get featureToAttributeMap(){return[{featureCode:"GenAIFeatures.UseSkillSchemaOperationRights",attributeName:"EnableRightsManagementUI"},{featureCode:"GenAIFeatures.UseFileHandling",attributeName:"EnableAttachmentsUI"},{featureCode:"GenAIFeatures.DisableSkillParametersUi",attributeName:"EnableParametersUI",invert:!0}]}get predefinedFilterValueMap(){return[{filterAttributeName:"AccessRightsDetail_PredefinedFilter",filterValueAttributeName:"Id",filterEntityColumnPath:"SysSchemaUId"},{filterAttributeName:"IntentFileList_PredefinedFilter",filterValueAttributeName:"Id",filterEntityColumnPath:"IntentUId"}]}_getDataValueTypeLookupValues(e=!1){const t=[...this._availableDataValueTypes];return e&&t.push(E.r.COMPOSITE_OBJECT_LIST),Object.keys(ee.Q).filter(s=>{const i=ee.Q[s];return t.includes(i.type)}).map(s=>{const i=ee.Q[s];return{displayValue:this._translateService.instant(i.translateKey),value:i.id}}).sort((s,i)=>s.displayValue.localeCompare(i.displayValue))}handle(e){var t=()=>super.handle,s=this;return(0,d.A)(function*(){const i=e.$context;i.AvailableInputDataValueTypes=s._getDataValueTypeLookupValues(!0),i.AvailableOutputDataValueTypes=s._getDataValueTypeLookupValues(),yield t().call(s,e)})()}};ct=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotIntentPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AISkills_FormPage"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],ct);let lt=class extends ys{constructor(e){super(e)}get featureToAttributeMap(){return[{featureCode:"GenAIFeatures.UseFileHandling",attributeName:"EnableAttachmentsUI"}]}get predefinedFilterValueMap(){return[{filterAttributeName:"AgentFileList_PredefinedFilter",filterValueAttributeName:"Id",filterEntityColumnPath:"IntentUId"}]}};lt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotAgentPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AIAgents_FormPage"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],lt);let dt=class extends f.l{handle(e){var t=this;return(0,d.A)(function*(){const n=yield(yield e.$context[e.collectionName])?.findByPrimaryAttribute(e.primaryColumnValue);n&&(n[e.attributeName]=e.attributeValue??ee.Q[E.r.MAXSIZE_TEXT].id),yield t.next?.handle(e)})()}};dt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotIntentParameterDataValueTypeChangeHandler",requestType:"crt.CopilotIntentParameterDataValueTypeChangeRequest",scopes:["AISkills_FormPage"]})],dt);var _i=r(65288);let ut=class extends f.l{handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context,i=yield t.next.handle(e);if(i){const o=(e.recordIds??[]).map(p=>(0,l.lastValueFrom)(s.delete(e.dataSourceName,[{type:_i.E.PrimaryColumnValue,value:p}])));yield Promise.all(o)}return i})()}};ut=(0,c.__decorate)([(0,C.l)({requestType:"crt.DeleteRecordsRequest",type:"crt.CopilotIntentParameterDeleteItemHandler",scopes:["AISkills_FormPage"]})],ut);let ht=class extends f.l{_extractTemplateParameters(e){const t=/\[#\s*([a-zA-Z_][a-zA-Z0-9_.]*)\s*#]/g,s=new Set;let i;for(;(i=t.exec(e))!==null;)s.add(i[1]);return Array.from(s)}handle(e){var t=this;return(0,d.A)(function*(){if(e.attributeName==="PDS_Prompt"){const s=e.$context;s.Prompt_tooltip=null;const i=e.value?e.value:yield s.PDS_Prompt,n=t._extractTemplateParameters(i);if(n.length>0){const p=(yield s.InputParametersDetail).map(g=>g.attributes.InputParametersDS_Code),h=n.filter(g=>!p.includes(g));if(h.length>0){const g=yield s.Resources.Strings.MissingPromptParameterWarning;s.Prompt_tooltip=g.replace("{0}",h.join(", "))}}}return t.next?.handle(e)})()}};ht=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotIntentPromptChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]})],ht);var Ss=r(22592);const yi="workspace-explorer-items-reload";var vs=r(99298),Si=r(97502);const vi=["InputParametersDetail","OutputParametersDetail"];let pt=class extends f.l{constructor(e,t,s,i,n){super(),this._broadcastChannelFactory=e,this._baseViewModelProcessValidationResultService=t,this._notifyService=s,this._intentManager=i,this._maskService=n,this._init()}_init(){this._workspaceReloadBroadcastService=this._broadcastChannelFactory.createInstance(yi)}_saveDataSafely(e){return e().catch(t=>[this._createFailedSaveResult(t?.message)])}_createFailedSaveResult(e){return{success:!1,rowsAffected:0,errorInfo:e}}_saveInnerViewModelCollection(e,t,s){var i=this;return(0,d.A)(function*(){const n={type:"crt.SaveCollectionPrimaryDataRequest",$context:e,collectionAttributeName:t,scopes:s};return yield i.handlerChain.process(n)})()}_validatePrimaryModel(e){var t=this;return(0,d.A)(function*(){const s=yield e.getPrimaryModelName();if(!(yield e.isValid(s))){const n=yield e.validate(s),o=yield t._baseViewModelProcessValidationResultService.getValidationErrorMessage(e,n);throw new Error(o)}})()}_showErrorDialog(e){var t=this;return(0,d.A)(function*(){const s=e?.message;s&&(yield t._notifyService.show({message:s}))})()}_aggregateDataSourceSaveResults(e){const t=e.map(s=>s?.errorInfo).filter(Boolean);return{success:e.length===0||e.every(s=>s?.success),errors:t.length===0?void 0:t.join(`
`)}}_handleApiModeSave(e,t){var s=this;return(0,d.A)(function*(){const i="RECORD_SAVING";yield s._maskService.showMask(i,e);try{yield s._validatePrimaryModel(e);const n=vi.map(h=>s._saveDataSafely(()=>s._saveInnerViewModelCollection(e,h,t))),o=yield Promise.all(n),p=s._aggregateDataSourceSaveResults(o.flat());if(!p.success)throw new Error(p.errors)}catch(n){return yield s._showErrorDialog(n),!1}finally{yield s._maskService.hideMask(i,e)}return!0})()}handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context;if((yield s.IsApiMode)&&!(yield t._handleApiModeSave(s,e.scopes)))return!1;const i=yield t.next?.handle(e);if(i){const n=yield s.PDS_Id,o=yield s.PDS_ParentIntentId;let p;o?(yield(0,l.lastValueFrom)(t._intentManager.createSubIntent(o,n)),p=tt.M.Create):p=tt.M.Update,ms.q.instance.notify({modelId:(0,v.qv)(),dataSchemaName:"CopilotAgentSubSkill",type:p,payload:{primaryAttributesValues:[[{name:"Id",value:n}]]}})}return t._workspaceReloadBroadcastService.publish(),i})()}};pt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotIntentSaveHandler",requestType:"crt.SaveRecordRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,c.__param)(4,(0,ds.j)(vs.V)),(0,c.__metadata)("design:paramtypes",[Ce.Vx,Si.i,Be.F,U.R,Ss.s])],pt);var gt=r(13555);let mt=class extends f.l{constructor(e){super(),this._copilotChatService=e.get(J),this._userInfo=e.get(se.oq),this._copilotToChatConvertor=e.get(k),this._featureValues=e.get(ae.G),this._chatDraftService=e.get(gt.X)}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,s){var i=this;return(0,d.A)(function*(){const n=yield e.$context[s];e.$context[s]=[...n,...i._getConvertedMessages(t)]})()}_saveProfile(e,t){return(0,d.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield D.t.instance.process(s)})()}handle(e){var t=this;return(0,d.A)(function*(){const s=e.attributesMapping,i=s?.chatInput,n=s.chatId;let o=yield e.$context[n];if(!(0,_.isEmpty)(i)){const p=yield e.$context[i];e.$context[i]="",t._chatDraftService.clearDraft(o),(0,_.isEmpty)(o)?(o=(0,v.qv)(),e.$context[n]=o,yield t._saveProfile(e.$context,e.scopes)):e.$context[n]=o;const h=yield t._copilotChatService.sayToSessionWithResponse(p,o);if(!h)e.$context[i]=p;else if(h?.messages.length){const g=s?.chatMessages;(0,_.isEmpty)(g)||(yield t._addMessageToConversation(e,h.messages,g))}}yield t.next?.handle(e)})()}};mt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],mt);var Is=r(43778),As=r(96158);let Ct=class extends f.l{constructor(e){super(),this._injector=e,this._translateService=this._injector.get(S.TranslateService),this._chatDraftService=this._injector.get(gt.X)}_setDefaultValuesIfNeeded(e){e.chatMessagesAttributeName??="ChatMessages",e.sessionIdAttributeName??="CurrentCopilotSessionId",e.sessionTitleAttributeName??="CurrentCopilotSessionTitle",e.conversationEventAttributeName??="ConversationEvent"}_saveProfile(e,t){return(0,d.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield D.t.instance.process(s)})()}handle(e){var t=this;return(0,d.A)(function*(){t._setDefaultValuesIfNeeded(e);const s=e.$context;!(0,_.isEmpty)(e.chatMessagesAttributeName)&&!(0,_.isEmpty)(e.conversationEventAttributeName)&&(s[e.chatMessagesAttributeName]=[],s[e.conversationEventAttributeName]=[{name:Is.R}]),s[e.sessionIdAttributeName]=null,s[e.sessionTitleAttributeName]=t._translateService.instant("Copilot.NewChatCaption"),(yield e.$context.IsCombinedMode)||(e.$context.ChatsListVisible=!1,e.$context.IsTyping=!1),e.$context.ChatInput=t._chatDraftService.getDraft(null),e.$context.MessageEditorInputAction=As.g.Focus,setTimeout(()=>e.$context.MessageEditorInputAction="",0),yield t._saveProfile(e.$context,e.scopes),yield t.next?.handle(e)})()}};Ct=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotNewChatHandler",requestType:"crt.CopilotNewChatRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Ct);var Ms=r(61541);let ft=class extends f.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(U.R)}_getModelInitConfig(e){return(0,d.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(i=>i.name===s)})()}_getIntent(e,t){var s=this;return(0,d.A)(function*(){let i;const o=(yield e.getPrimaryDataSchema())?.name;return o==="CopilotIntent"||o==="CopilotAgent"?i=yield(0,l.firstValueFrom)(s._intentManager.getIntent(t)):o==="CopilotAction"&&(i=yield(0,l.firstValueFrom)(s._intentManager.getIntentByActionUId(t))),i})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e);const s=e.$context,i=yield t._getModelInitConfig(s);if(!(i?.action===Ms.n.Edit))return;(yield t._getIntent(s,i?.recordId))?.ExtendParent&&t._disableCodeField(s)})()}};ft=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AISkills_FormPage","AIProcessActions_FormPage","AIAgents_FormPage"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],ft);const w={process:"ProcessSchemaUId",params:"PDS_Params"};let _t=class extends f.l{constructor(e){super(),this._customEventService=e}_getIsAddAction(e){return(0,d.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(n=>n.name===s)?.action===Ms.n.Add})()}handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context;s[w.process]=null;const i=yield t.next?.handle(e);if(yield t._getIsAddAction(s))return i;const n=yield s.ProcessDesignerInstanceId;return yield new Promise(o=>{const p={designerInstanceId:n,callback:o};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(p)}),i})()}};_t=(0,c.__decorate)([(0,C.l)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["AIProcessActions_FormPage"]}),(0,c.__metadata)("design:paramtypes",[Ce.Dj])],_t);var xs=r(89285),Ps=r(32053);function Es(a){return yt.apply(this,arguments)}function yt(){return yt=(0,d.A)(function*(a){const e="ProcessDesignerInstanceId";let t=yield a[e];t||(t=(0,v.qv)(),a[e]=t)}),yt.apply(this,arguments)}let St=class extends f.l{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",Ps.j7,w.process]}_handleProcessChange(e){if(e.attributeName===w.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[w.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,d.A)(function*(){e.attributeName===Ps.yM&&e.value===xs.b.Create&&(e.$context[w.process]=v.To,yield Es(e.$context))})()}handle(e){var t=this;return(0,d.A)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const s=yield e.$context.getPrimaryModelName();e.$context.getModelByName(s).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const s=yield e.$context[w.process],i=yield e.$context.ProcessSchemaIsLoaded,n=yield e.$context.ProcessSchemaIsChanged,o=yield e.$context.HasUnsavedData,p=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=i&&s!==v.To&&(o||p||n)}return t.next?.handle(e)})()}};St=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AIProcessActions_FormPage"]})],St);let vt=class extends f.l{_subscribeParamsLoaded(e){const t=new l.Subscription;t.add(e.events$.pipe((0,l.filter)(({type:s})=>s==="finish-load-model-attributes"),(0,l.filter)(({payload:s})=>s[w.params]),(0,l.switchMap)(()=>e[w.params]),(0,l.filter)(s=>!!s)).subscribe({next:function(){var s=(0,d.A)(function*(i){let n;try{n=JSON.parse(i).processSchemaUId}catch(h){console.error(`params = ${i}
${h?.message}`)}const o={silent:!0},p={[w.process]:n};e.setValue(p,o),yield Es(e)});return function(n){return s.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};vt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AIProcessActions_FormPage"]})],vt);let It=class extends f.l{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e,t){var s=this;return(0,d.A)(function*(){const i=yield e.ProcessDesignerInstanceId;return new Promise(n=>{const o={designerInstanceId:i,needSaveNewVersion:t,saveCallback:n};s._customEventService.createOutboundChannel("saveProcessSchema").next(o)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,d.A)(function*(){const s={type:"crt.NotificationRequest",$context:e,message:"Dialog.ProcessSchemaSavedWithValidationError"};yield t.handlerChain.process(s)})()}handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context,i=e.config,n=i?i.needSaveNewVersion:!1;if(!(yield s.isValid()))return yield t.next?.handle(e);const p=yield t._performDesignerSave(s,n);return p.isCanceled?!1:(p.isValid||(yield t._showDesignerValidationErrorNotification(s)),yield t.next?.handle(e))})()}};It=(0,c.__decorate)([(0,C.l)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["AIProcessActions_FormPage"]}),(0,c.__metadata)("design:paramtypes",[Ce.Dj,S.TranslateService])],It);let At=class extends f.l{constructor(e){super(),this._copilotChatService=e.get(R),this._copilotToEditorCommunicationService=e.get(Re.i)}handle(e){var t=this;return(0,d.A)(function*(){yield t._copilotChatService.closeSession();const s=e.chatMessagesAttributeName,i=e.conversationEventAttributeName,n=e.$context;e.sessionIdAttributeName&&(n[e.sessionIdAttributeName]=null),!(0,_.isEmpty)(s)&&!(0,_.isEmpty)(i)&&(n[s]=[],n[i]=[{name:Is.R}]),t._copilotToEditorCommunicationService.notify({editorAction:De.u.RemoveHighlighting}),yield t.next?.handle(e)})()}};At=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],At);var bs=r(50002);let Mt=class extends f.l{constructor(e){super(),this._copilotPanelCode=fe.b,this._sidebarStateService=e.get(is.p),this._copilotChatService=e.get(J),this._translateService=e.get(S.TranslateService),this._copilotToEditorCommunicationService=e.get(Re.i),this._profileService=e.get(ss.c),this._customEventService=e.get(Ce.Dj)}_getChatPanelProfileData(){var e=this;return(0,d.A)(function*(){return yield(0,l.firstValueFrom)(e._profileService.getProfile(ns.j))})()}_getChatSessionId(){var e=this;return(0,d.A)(function*(){const t=yield e._getChatPanelProfileData(),s=yield(0,l.firstValueFrom)(e._sidebarStateService.opened.rootSidebar$);return t&&!t.isChatsListVisible&&s===e._copilotPanelCode?t.lastChatId:null})()}_getPrompt(e,t){return["Friendly","Formal","Shorten","Extend","Rephrase","AskCopilot"].includes(t)?`${this._translateService.instant(`Copilot.RewriteActionsPrompt.${t}`)}: ${e}`:e}handle(e){var t=this;return(0,d.A)(function*(){const s=yield e.$context[e.selectionAttributeName];if(!(0,_.isEmpty)(s)){t._copilotToEditorCommunicationService.notify({editorAction:De.u.SetHighlighting,selection:s});const i=t._getPrompt(s,e.rewriteAction),n=yield t._getChatSessionId();yield t._sidebarStateService.openRootSidebar(t._copilotPanelCode);const o=yield t._copilotChatService.sayToSessionWithResponse(i,n);!n&&o?.copilotSession&&t._customEventService.createOutboundChannel(fe.k).next(o.copilotSession.id)}yield t.next?.handle(e)})()}};Mt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotRewriteTextHandler",requestType:"crt.SelectionActionRequest",scopes:[bs.M.AllCards,"BasePageFreedomTemplate","BaseSidebarTemplate",bs.M.AllSections]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Mt);let Ts=class extends Q.S{};Ts=(0,c.__decorate)([(0,F.$)({type:"crt.CopilotSelectExistingProcessRequest",scopes:["AISkills_FormPage"]})],Ts);let xt=class extends f.l{_saveIntent(e){var t=this;return(0,d.A)(function*(){const s=e.$context,i={type:"crt.SaveRecordRequest",preventCardClose:!0,preventCardStateChange:!0,$context:s,scopes:e.scopes},n=yield t.handlerChain.process(i);if(n){const o=yield s.getPrimaryModelName(),p=yield s.getPrimaryDataSchema(),h={type:"crt.LoadDataRequest",dataSourceName:o,parameters:[{type:"primaryColumnValue",value:p.primaryAttributeName}],$context:s,scopes:e.scopes};yield t.handlerChain.process(h)}return n})()}_getOpenLookupPageRequestConfig(e){var t=this;const{$context:s,scopes:i,caption:n,actionCode:o,intentId:p,packageUId:h}=e;return{type:"crt.OpenSelectionWindowRequest",$context:s,scopes:[...i],entitySchemaName:"VwProcessLib",caption:n,schemaName:"CopilotSelectExistingProcessForActionPage",afterClosed:function(){var g=(0,d.A)(function*(m){if(m.canceled)return;const N=yield m.getLookupValues(),[Z]=N;if(Z){const Pi=Z.value,Ei={type:"crt.CreateRecordRequest",$context:s,entityName:"CopilotAction",defaultValues:[{attributeName:"Intent",value:p},{attributeName:"Code",value:o},{attributeName:"PackageUId",value:h},{attributeName:"Params",value:JSON.stringify({processSchemaUId:Pi})}]};yield t.handlerChain.process(Ei)}});return function(N){return g.apply(this,arguments)}}(),filtersConfig:{filterAttributes:[{name:"processEnabledFilter",loadOnChange:!1}],attributesConfig:{processEnabledFilter:{value:{items:{"a1dbfcfe-84e1-4bba-ac51-a83194bf2f6a":{filterType:1,comparisonType:3,isEnabled:!0,trimDateTimeParameterToDate:!1,leftExpression:{expressionType:0,columnPath:"Enabled"},isAggregative:!1,dataValueType:12,rightExpression:{expressionType:2,parameter:{dataValueType:12,value:!0}}}},logicalOperation:0,isEnabled:!0,filterType:6,rootSchemaName:"VwProcessLib"}}}}}}handle(e){var t=this;return(0,d.A)(function*(){if((yield e.$context.HasUnsavedData)&&!(yield t._saveIntent(e)))return;const i=t._getOpenLookupPageRequestConfig(e);return yield t.handlerChain.process(i),t.next?.handle(e)})()}};xt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingProcessHandler",requestType:"crt.CopilotSelectExistingProcessRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]})],xt);let Ns=class extends Q.S{};Ns=(0,c.__decorate)([(0,F.$)({type:"crt.CopilotSelectExistingSkillRequest",scopes:["AIAgents_FormPage"]})],Ns);let Pt=class extends f.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(U.R),this._maskService=this.injector.get(vs.V)}_saveAgent(e){const{$context:t,scopes:s}=e,i={type:"crt.SaveRecordRequest",preventCardClose:!0,preventCardStateChange:!0,$context:t,scopes:s};return this.handlerChain.process(i)}_getOpenLookupPageRequestConfig(e){var t=this;const{$context:s,scopes:i,caption:n}=e;return{type:"crt.OpenSelectionWindowRequest",$context:s,scopes:[...i],entitySchemaName:"CopilotIntent",caption:n,schemaName:"CopilotSelectExistingSkillForAgentPage",afterClosed:function(){var o=(0,d.A)(function*(p){yield t._afterClosed(p,e)});return function(h){return o.apply(this,arguments)}}()}}_afterClosed(e,t){var s=this;return(0,d.A)(function*(){if(e.canceled)return;const i=yield e.getLookupValues(),[n]=i;if(n){const o=n.value,{agentId:p,$context:h,scopes:g}=t,m="CREATE_SUB_INTENT";yield s._maskService.showMask(m,h),yield(0,l.lastValueFrom)(s._intentManager.createSubIntent(p,o)),yield s.handlerChain.process({type:"crt.LoadDataRequest",dataSourceName:"SubSkillsDetailDS",config:{loadType:ps.I.Reload},$context:h,scopes:g}),yield s._maskService.hideMask(m,h)}})()}handle(e){var t=this;return(0,d.A)(function*(){if((yield e.$context.HasUnsavedData)&&!(yield t._saveAgent(e)))return;const i=t._getOpenLookupPageRequestConfig(e);return yield t.handlerChain.process(i),t.next?.handle(e)})()}};Pt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingSkillHandler",requestType:"crt.CopilotSelectExistingSkillRequest",scopes:["AIAgents_FormPage"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Pt);let Rs=class extends Q.S{};Rs=(0,c.__decorate)([(0,F.$)({type:"crt.CopilotShowDebugInfoRequest",scopes:["CopilotPanel"]})],Rs);let Et=class extends f.l{constructor(e){super(),this._copilotChatService=e.get(R),this._translateService=e.get(S.TranslateService),this._dialogService=e.get(Ye.o),this._maskService=e.get(Ss.s),this._featureService=e.get(_s.d)}_openDebugInfoPage(e,t,s){var i=this;return(0,d.A)(function*(){const n={schemaName:"AIDebugInfo",type:"crt.OpenPageRequest",$context:e.$context,skipUnsavedData:!0,parameters:{PlainInfo:s,DebugInfo:t}};yield i.handlerChain.process(n)})()}_useSyntaxHighlight(e){const t={strings:"#181818",booleans:"#219",numbers:"#164",keys:"#757575"};return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[[:alnum:]]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g,s=>{let i=t.numbers;return s.startsWith('"')?i=s.endsWith(":")?t.keys:t.strings:["null","true","false"].includes(s)&&(i=t.booleans),`<span style="color:${i}">${s}</span>`})}_useIndentation(e){return e.replaceAll("\u2003","&emsp;").replaceAll("\\n","\\a").replaceAll(`
`,"<br>").replaceAll("\\a","\\n")}handle(e){var t=this;return(0,d.A)(function*(){const s=yield(0,l.lastValueFrom)(t._featureService.getFeatureState("ShowSystemMessagesFromCopilot"));yield t._maskService.showBodyMask();const i=e.sessionId,n=i?t._copilotChatService.getCopilotSessionMessages(i):t._copilotChatService.getInitialMessages$();yield(0,l.firstValueFrom)(n.pipe((0,l.map)(o=>s?o:o.slice(1)),(0,l.tap)(function(){var o=(0,d.A)(function*(p){if(!p||p.length===0){const m=t._translateService.instant("Copilot.DebugInfo.NoDebugInfo");yield t._maskService.hideBodyMask(),t._dialogService.openInfoDialog(m);return}const h=JSON.stringify(p,null,"\u2003");let g=t._useSyntaxHighlight(h);g=t._useIndentation(g),yield t._openDebugInfoPage(e,g,h),yield t._maskService.hideBodyMask()});return function(p){return o.apply(this,arguments)}}())))})()}};Et=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotShowDebugInfoHandler",requestType:"crt.CopilotShowDebugInfoRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Et);let bt=class extends f.l{constructor(e){super(),this._copilotToEditorCommunicationService=e.get(Re.i)}handle(e){var t=this;return(0,d.A)(function*(){t._copilotToEditorCommunicationService?.notify({editorAction:De.u.RemoveHighlighting}),yield t.next?.handle(e)})()}};bt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotViewModelPauseHandler",requestType:"crt.HandleViewModelPauseRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],bt);class Tt extends Q.S{}class Nt extends f.l{constructor(e){super(),this.injector=e,this._initialCodeValueAttributeName="_InitialCodeValue",this.intentManager=this.injector.get(U.R)}loadCodes(e,t){return this.getCodes(e,t).pipe((0,l.tap)(s=>e[this.cacheAttributeName]=s))}handle(e){var t=this;return(0,d.A)(function*(){const s=e.$context;if(s.PrimaryModelMode!==xs.b.Create){yield t.next?.handle(e);return}let i=yield s[t._initialCodeValueAttributeName];i||(i=yield t.initializeCodeValue(s,e),s[t._initialCodeValueAttributeName]=i);const n=yield s[e.valueAttributeName];if(!n){s[e.codeAttributeName]=i;return}const o=yield s[t.cacheAttributeName],h=(o?.length>0?(0,l.of)(o):t.loadCodes(s,e)).pipe((0,l.switchMap)(g=>t.generateCode(g,n)));s[e.codeAttributeName]=(yield(0,l.lastValueFrom)(h))??i,yield t.next?.handle(e)})()}}let Ds=class extends Tt{};Ds=(0,c.__decorate)([(0,F.$)({type:"crt.GenerateCopilotActionCodeValueRequest"})],Ds);let Rt=class extends Nt{constructor(e){super(e),this.cacheAttributeName="_ActionCodes_Cache"}getCodes(e,t){return(0,l.from)(e[t.intentAttributeName]).pipe((0,l.switchMap)(s=>this.intentManager.getIntent(s?.value).pipe((0,l.map)(i=>i.Actions.map(n=>n.Code)))))}generateCode(e,t){return this.intentManager.generateActionCode(e,t)}initializeCodeValue(e,t){return e[t.codeAttributeName]}};Rt=(0,c.__decorate)([(0,C.l)({type:"crt.GenerateCopilotActionCodeValueHandler",requestType:"crt.GenerateCopilotActionCodeValueRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Rt);let Vs=class extends Tt{};Vs=(0,c.__decorate)([(0,F.$)({type:"crt.GenerateAgentCodeValueRequest"})],Vs);let Dt=class extends Nt{constructor(e){super(e),this.cacheAttributeName="_AgentCodes_Cache"}getCodes(){return this.intentManager.getAllAgents()}generateCode(e,t){return this.intentManager.generateAgentCode(e,t)}initializeCodeValue(e,t){return(0,l.lastValueFrom)(this.loadCodes(e,t).pipe((0,l.switchMap)(s=>this.generateCode(s,""))))}};Dt=(0,c.__decorate)([(0,C.l)({type:"crt.GenerateAgentCodeValueRequestHandler",requestType:"crt.GenerateAgentCodeValueRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Dt);let Fs=class extends Tt{};Fs=(0,c.__decorate)([(0,F.$)({type:"crt.GenerateSkillCodeValueRequest"})],Fs);let Vt=class extends Nt{constructor(e){super(e),this.cacheAttributeName="_SkillCodes_Cache"}getCodes(){return this.intentManager.getAllSkills()}generateCode(e,t){return this.intentManager.generateSkillCode(e,t)}initializeCodeValue(e,t){return(0,l.lastValueFrom)(this.loadCodes(e,t).pipe((0,l.switchMap)(s=>this.generateCode(s,""))))}};Vt=(0,c.__decorate)([(0,C.l)({type:"crt.GenerateSkillCodeValueRequestHandler",requestType:"crt.GenerateSkillCodeValueRequest"}),(0,c.__metadata)("design:paramtypes",[u.Injector])],Vt);class bi extends null{}let Ft=class extends f.l{constructor(e,t,s){super(),this._copilotChatService=e,this._userInfo=s,this._copilotToChatConvertor=t.get(k),this._chatDraftService=t.get(gt.X)}_getConvertedMessages(e){return e?this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId}):[]}_saveProfile(e,t){return(0,d.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield D.t.instance.process(s)})()}_fetchSessionPreview(e){return(0,l.lastValueFrom)(this._copilotChatService.getActiveSessionPreviewById(e))}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e);const s=e.session.id;e.$context.ChatsListVisible=!1,e.$context.ChatMessages=[],e.$context.ConversationLoading=!0;const i=t._getConvertedMessages(yield(0,l.lastValueFrom)(t._copilotChatService.getCopilotSessionMessages(s).pipe((0,l.tap)(()=>{e.$context.ConversationLoading=!1}))));e.$context.IsTyping=!1,e.$context.ChatMessages=i,e.$context.CurrentCopilotSessionTitle=e.session.caption??(yield t._fetchSessionPreview(s))?.caption,e.$context.CurrentCopilotSessionId=s,e.$context.ChatInput=t._chatDraftService.getDraft(s),e.$context.MessageEditorInputAction=As.g.Focus,setTimeout(()=>e.$context.MessageEditorInputAction="",0),yield t._saveProfile(e.$context,e.scopes)})()}};Ft=(0,c.__decorate)([(0,C.l)({type:"crt.ChatSessionOpenHandler",requestType:"crt.ChatSessionOpenRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[R,u.Injector,se.oq])],Ft);class Ti extends null{}let $t=class extends f.l{_saveProfile(e,t){return(0,d.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield D.t.instance.process(s)})()}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e),e.$context.ChatsListVisible=!0,e.$context.ChatInput="",yield t._saveProfile(e.$context,e.scopes)})()}};$t=(0,c.__decorate)([(0,C.l)({type:"crt.ChatListOpenHandler",requestType:"crt.ChatListOpenRequest",scopes:["CopilotPanel"]})],$t);var Ii=r(95145);class H{constructor(e,t,s){this._sysSettingsService=e,this._notifyService=t,this._translateService=s,this._defaultFileExtensions="txt,docx,pdf",this._defaultMaxFileSize=5,this._maxIntentFileSizeSettingName="CreatioAIMaxIntentFileSize",this._maxSessionFileSizeSettingName="CreatioAIMaxSessionFileSize",this._allowedFileExtensionsSettingName="CreatioAIAllowedFileExtensions",this._intentMaxSizeExceptionKey="IntentMaxSizeException",this._chatMaxSizeExceptionKey="ChatMaxSizeException",this._intentMissingTypeExceptionKey="IntentMissingTypeException",this._chatMissingTypeExceptionKey="ChatMissingTypeException",this._intentNotSupportedTypeExceptionKey="IntentTypeNotSupportedException",this._chatNotSupportedTypeExceptionKey="ChatTypeNotSupportedException"}_validateFile(e,t,s,i){if(e.size/1024/1024>t){const p=i?this._chatMaxSizeExceptionKey:this._intentMaxSizeExceptionKey,h=this._getLocalizedException(p,t.toString(),i?this._maxSessionFileSizeSettingName:this._maxIntentFileSizeSettingName);throw new Error(h)}const o=e.name.includes(".")?e.name.split(".").pop()?.toLowerCase():null;if(!o){const p=this._getLocalizedException(i?this._chatMissingTypeExceptionKey:this._intentMissingTypeExceptionKey,s.join(","));throw new Error(p)}if(!s.includes(o)){const p=this._getLocalizedException(i?this._chatNotSupportedTypeExceptionKey:this._intentNotSupportedTypeExceptionKey,o,s.join(","));throw new Error(p)}}_getAllowedFileExtensionsSetting(){var e=this;return(0,d.A)(function*(){return(yield(0,l.lastValueFrom)(e._sysSettingsService.getByCode(e._allowedFileExtensionsSettingName)))?.value??e._defaultFileExtensions})()}_getAllowedFileExtensions(){var e=this;return(0,d.A)(function*(){return(yield e._getAllowedFileExtensionsSetting()).split(",").map(t=>t.trim())})()}_getMaxSizeSystemSetting(e){var t=this;return(0,d.A)(function*(){return(yield(0,l.lastValueFrom)(t._sysSettingsService.getByCode(e)))?.value??t._defaultMaxFileSize})()}_showErrorDialog(e){var t=this;return(0,d.A)(function*(){const s=e?.message;s&&(yield t._notifyService.show({message:s}))})()}_getLocalizedException(e,...t){const s=`Copilot.FileMessages.${e}`,i=this._translateService.instant(s);return hs.String.format(i,...t)}validateIntentFiles(...e){var t=this;return(0,d.A)(function*(){try{const s=yield t._getMaxSizeSystemSetting(t._maxIntentFileSizeSettingName),i=yield t._getAllowedFileExtensions();return e.forEach(n=>{t._validateFile(n,s,i,!1)}),!0}catch(s){return yield t._showErrorDialog(s),!1}})()}validateSessionFiles(...e){var t=this;return(0,d.A)(function*(){const s=yield t._getMaxSizeSystemSetting(t._maxSessionFileSizeSettingName),i=yield t._getAllowedFileExtensions();e.forEach(n=>{t._validateFile(n,s,i,!0)})})()}static{this.\u0275fac=function(t){return new(t||H)(u.\u0275\u0275inject(Ii.A),u.\u0275\u0275inject(Be.F),u.\u0275\u0275inject(S.TranslateService))}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:H,factory:H.\u0275fac,providedIn:"root"})}}class X{_getCurrentUserTime(){const i=(new Date().getTime()*1e4+621355968e9)/1e4;return new Date(i)}addErrorToChatMessages(e,t){const s={text:e,id:(0,v.qv)(),author:Te.contact,date:this._getCurrentUserTime(),isBotMessage:!0,type:He.X.Text,direction:me.Tt.Incoming},i=Object.assign([],t);return i.push(s),i}static{this.\u0275fac=function(t){return new(t||X)}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac,providedIn:"root"})}}let Ut=class extends f.l{constructor(e,t){super(),this._fileValidatorService=e,this._copilotChatMessageService=t}handle(e){var t=this;return(0,d.A)(function*(){if(e.recordId===null){const s=(0,v.qv)();e.$context.CurrentCopilotSessionId=s,e.recordId=s}if(e.files?.length)try{yield t._fileValidatorService.validateSessionFiles(...e.files)}catch(s){const i=yield e.$context.ChatMessages,n=s?.message;i&&n&&(e.$context.ChatMessages=t._copilotChatMessageService.addErrorToChatMessages(n,i));return}return t.next?.handle(e)})()}};Ut=(0,c.__decorate)([(0,C.l)({requestType:"crt.UploadFileRequest",type:"crt.CopilotChatUploadFileHandler",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[H,X])],Ut);class Ni extends null{}let Lt=class extends f.l{_saveProfile(e,t){return(0,d.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield D.t.instance.process(s)})()}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e);const s=yield e.$context.CombinedModeEnabled;e.$context.ChatsListVisible=!s,e.$context.IsCombinedMode=!s,e.$context.CombinedModeEnabled=!(yield e.$context.CombinedModeEnabled),yield t._saveProfile(e.$context,e.scopes)})()}};Lt=(0,c.__decorate)([(0,C.l)({type:"crt.CombinedChatViewHandler",requestType:"crt.CombinedChatViewRequest",scopes:["CopilotPanel"]})],Lt);let wt=class extends f.l{constructor(e){super(),this._fileValidatorService=e}handle(e){var t=this;return(0,d.A)(function*(){const s=yield t.next?.handle(e);return s.files.length&&!(yield t._fileValidatorService.validateIntentFiles(...s.files))?{files:[],errors:[]}:s})()}};wt=(0,c.__decorate)([(0,C.l)({requestType:"crt.SelectFileRequest",type:"crt.CopilotIntentUploadFileDialogHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,c.__metadata)("design:paramtypes",[H])],wt);let Ht=class extends f.l{constructor(e){super(),this._fileValidatorService=e}handle(e){var t=this;return(0,d.A)(function*(){if(!(e.files?.length&&!(yield t._fileValidatorService.validateIntentFiles(...e.files))))return t.next?.handle(e)})()}};Ht=(0,c.__decorate)([(0,C.l)({requestType:"crt.UploadFileRequest",type:"crt.CopilotIntentUploadFileHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,c.__metadata)("design:paramtypes",[H])],Ht);let Ot=class extends f.l{constructor(e,t){super(),this._fileValidatorService=e,this._copilotChatMessageService=t}handle(e){var t=this;return(0,d.A)(function*(){const s=yield t.next?.handle(e);if(s.files.length)try{yield t._fileValidatorService.validateSessionFiles(...s.files)}catch(i){const n=yield e.$context.ChatMessages,o=i?.message;return n&&o&&(e.$context.ChatMessages=t._copilotChatMessageService.addErrorToChatMessages(o,n)),{files:[],errors:[]}}return s})()}};Ot=(0,c.__decorate)([(0,C.l)({requestType:"crt.SelectFileRequest",type:"crt.CopilotChatUploadFileDialogHandler",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[H,X])],Ot);var Ai=r(37206);class Ri extends null{}let jt=class extends Ai.w{constructor(e){super(),this._copilotChatService=e}getChatPreviews(e,t){return this._copilotChatService.getActiveSessionsWithPreview(e,t)}mapChatPreview(e){return this._copilotChatService.mapSessions(e)}};jt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotChatListLoadHandler",requestType:"crt.CopilotChatListLoadRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[R])],jt);var $s=r(58504),Mi=r(61320),xi=r(63058);class ne{constructor(){this._queryExecutor=(0,u.inject)(Yt.w)}_buildContactQuery(e,t,s){const i=new Zt.s("CopilotAgent");i.rowCount=s,i.rowsOffset=t,i.addSchemaColumn("Id");const n=i.addSchemaColumn("Name");return i.addSchemaColumn("Description"),i.filters.addSchemaColumnFilterWithParameter($s.H.Contain,"Name",e),i.filters.addSchemaColumnFilterWithParameter($s.H.Equal,"Status",xi.d.get("Active")),n.orderDirection=Mi.Z.Asc,n.orderPosition=0,i}getContacts(e,t=0,s=15){const i=this._buildContactQuery(e,t,s);return this._queryExecutor.executeSelectQuery(i).pipe((0,l.map)(n=>n.map(o=>({displayValue:o.Name,value:o.Id,description:o.Description}))))}static{this.\u0275fac=function(t){return new(t||ne)}}static{this.\u0275prov=u.\u0275\u0275defineInjectable({token:ne,factory:ne.\u0275fac,providedIn:"root"})}}class Di extends null{}let kt=class extends f.l{constructor(e){super(),this._copilotMentionsService=e}handle(e){var t=this;return(0,d.A)(function*(){yield t.next?.handle(e),e.initService(t._copilotMentionsService)})()}};kt=(0,c.__decorate)([(0,C.l)({type:"crt.CopilotMentionInitHandler",requestType:"crt.CopilotMentionInitRequest",scopes:["CopilotPanel"]}),(0,c.__metadata)("design:paramtypes",[ne])],kt);let Ve=class Gt{static{this.\u0275fac=function(t){return new(t||Gt)}}static{this.\u0275mod=u.\u0275\u0275defineNgModule({type:Gt})}static{this.\u0275inj=u.\u0275\u0275defineInjector({providers:[j.F,k,P.d],imports:[ie,ge,S.TranslateModule]})}};Ve=(0,c.__decorate)([(0,V.g)({viewElements:[],requestHandlers:[Ge,jt,We,kt,Qe,Je,Xe,Ze,qe,st,it,nt,at,ot,rt,ct,lt,dt,ut,ht,pt,mt,Ct,ft,_t,St,vt,It,At,Mt,xt,Pt,Et,bt,Rt,Dt,Vt,Ft,$t,Ut,Lt,wt,Ht,Ot],converters:[Oe,je,ke,ze]})],Ve),function(){(typeof ngJitMode>"u"||ngJitMode)&&u.\u0275\u0275setNgModuleScope(Ve,{imports:[ie,ge,S.TranslateModule]})}()},96158:(O,M,r)=>{r.d(M,{g:()=>c});var c;(function(P){P.TriggerMention="triggerMention",P.Focus="focus"})(c||(c={}))},37206:(O,M,r)=>{r.d(M,{D:()=>T,w:()=>u});var c=r(73308),P=r(81517),V=r(41287),S=r(62278),j=r.n(S);class T extends P.S{constructor(){super(...arguments),this.isFirstLoad=!1}}class u extends V.l{constructor(){super(...arguments),this._chatsLoadOffset$=new S.Subject}_handleChatsListOffsetChange(y){this._chatsLoadOffset$.pipe((0,S.debounceTime)(500),(0,S.distinctUntilChanged)((I,_)=>I.offset===_.offset),(0,S.tap)(()=>y.$context.IsActiveChatsLoading=!0),(0,S.switchMap)(I=>this.getChatPreviews(I.offset,I.rowsToLoad).pipe((0,S.filter)(_=>I.offset===0||_&&_.length>0),(0,S.map)(_=>_.map(l=>this.mapChatPreview(l))),(0,S.switchMap)(_=>(0,S.from)(y.$context.ActiveChats).pipe((0,S.take)(1),(0,S.map)(l=>!l||l.length===0?_:[...l,..._]))),(0,S.map)(_=>({page:I.currentPage,mappedSessions:_})),(0,S.finalize)(()=>{y.$context.IsActiveChatsLoading=!1})))).subscribe(I=>{y.$context.ActiveChats=Array.from(new Map(I.mappedSessions.map(_=>[_.id,_])).values()),y.$context.ChatsListPage=I.page+1})}handle(y){var I=this;return(0,c.A)(function*(){yield I.next?.handle(y),y.isFirstLoad&&(I._handleChatsListOffsetChange(y),y.$context.ChatsListPage=0);const _=yield y.$context.ChatsListPage,l=_*y.rowsToLoadCount;I._chatsLoadOffset$.next({offset:l,rowsToLoad:y.rowsToLoadCount,currentPage:_})})()}}},13161:(O,M,r)=>{r.d(M,{j:()=>c});const c="ChatPanel"},43778:(O,M,r)=>{r.d(M,{R:()=>P,u:()=>c});class c{}const P="reset"},13555:(O,M,r)=>{r.d(M,{X:()=>u});var c=r(62278),P=r.n(c),V=r(36486),S=r.n(V),j=r(59131),T=r.n(j);class u{constructor(){this._saveMessageDebounceTimeout=500,this._storageKeyPrefix="chat-draft",this._draftUpdatesMap=new Map}_getOrCreateSubject(y){if(!this._draftUpdatesMap.has(y)){const I=new c.Subject;I.pipe((0,V.debounceTime)(this._saveMessageDebounceTimeout)).subscribe(_=>{const l=this._getStorageKey(y);_===null?sessionStorage.removeItem(l):sessionStorage.setItem(l,_)}),this._draftUpdatesMap.set(y,I)}return this._draftUpdatesMap.get(y)}_getStorageKey(y){return`${this._storageKeyPrefix}-${y||"new"}`}setDraft(y,I){this._getOrCreateSubject(y).next(I)}getDraft(y){const I=this._getStorageKey(y);return sessionStorage.getItem(I)||""}clearDraft(y){this._getOrCreateSubject(y).next(null)}ngOnDestroy(){this._draftUpdatesMap.forEach(y=>{y.complete()}),this._draftUpdatesMap.clear()}static{this.\u0275fac=function(I){return new(I||u)}}static{this.\u0275prov=j.\u0275\u0275defineInjectable({token:u,factory:u.\u0275fac,providedIn:"root"})}}},20555:(O,M,r)=>{r.d(M,{b:()=>P,k:()=>c});const c="OpenChatSessionEvent",P="Copilot"},85040:(O,M,r)=>{r.d(M,{u:()=>c});var c;(function(P){P.SetHighlighting="setHighlighting",P.RemoveHighlighting="removeHighlighting"})(c||(c={}))},48534:(O,M,r)=>{r.d(M,{i:()=>T});var c=r(62278),P=r.n(c),V=r(85040),S=r(59131),j=r.n(S);class T{constructor(){this._currentSubscriptionIdentifier=null,this._currentSubscription=null,this._replaceSelectionSubject=new c.Subject}_unsubscribeLastEditor(){if(this._currentSubscription){const x={editorAction:V.u.RemoveHighlighting};this._replaceSelectionSubject?.next(x),this._currentSubscriptionIdentifier=null,this._currentSubscription.unsubscribe()}}subscribeToNotifications(x,y){this._currentSubscriptionIdentifier!==x&&(this._unsubscribeLastEditor(),this._currentSubscriptionIdentifier=x,this._currentSubscription=this._replaceSelectionSubject.subscribe(y))}notify(x){this._replaceSelectionSubject?.next(x)}static{this.\u0275fac=function(y){return new(y||T)}}static{this.\u0275prov=S.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac,providedIn:"root"})}}}}]);
