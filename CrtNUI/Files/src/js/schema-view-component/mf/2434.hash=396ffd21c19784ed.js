(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[2434],{43272:(lt,S,n)=>{n.d(S,{A:()=>R});var c=n(18587),v=n(49973),A=n(58504),C=n(74709),b=n(43785),E=n(62278),U=n.n(E),u=n(36486),L=n.n(u);class R{constructor(s,t,l){this.queryExecutor=s,this._translateService=t,this.entityConverter=l,this.absentDataErrorKey="BaseSection.AbsentDataErrorMessage",this.primaryColumnName="Id"}_convertToErrorInfo(s){return{errorCode:null,message:s.message,stackTrace:s.stack}}_addColumnsToEsq(s){this.entityConverter.getEntityColumns({}).forEach(l=>{s.addSchemaColumn(l.path)})}_createDeleteQuery(){return new c.x(this.entitySchemaName)}getBaseErrorResponse(s){return(0,E.of)({success:!1,errorInfo:this._convertToErrorInfo(s),result:null})}handleResponse(s){return s.pipe((0,u.map)(()=>({success:!0,errorInfo:null,result:[]})),(0,u.catchError)(t=>(0,E.of)({success:!1,errorInfo:this._convertToErrorInfo(t),result:[]})))}getItemByIdEsq(s){const t=new v.s(this.entitySchemaName);return this._addColumnsToEsq(t),t.filters.addSchemaColumnFilterWithParameter(A.H.Equal,this.primaryColumnName,s),t}createGetAllItemsEsq(){const s=new v.s(this.entitySchemaName);return this._addColumnsToEsq(s),s}getUpdateQuery(s){const t=new C.N(this.entitySchemaName);return this.entityConverter.getEntityColumns(s).forEach(h=>{this.primaryColumnName===h.path?t.filters.addSchemaColumnFilterWithParameter(A.H.Equal,this.primaryColumnName,h.value):t.addColumn(h.path,h.value,h.type)}),t}getInsertQuery(s){const t=new b.L(this.entitySchemaName);return this.entityConverter.getEntityColumns(s).forEach(h=>{this.primaryColumnName===h.path&&!h.value||t.addColumn(h.path,h.value,h.type)}),t}getDeleteQuery(s){return this.getDeleteQueryWithPrimaryColumnFilter(s.id)}getDeleteQueryWithPrimaryColumnFilter(s){const t=this._createDeleteQuery();return t.filters.addSchemaColumnFilterWithParameter(A.H.Equal,this.primaryColumnName,s),t}loadAdditionalInfo(s){return(0,E.of)(s)}getItems(){const s=this.createGetAllItemsEsq();return this.queryExecutor.executeSelectQuery(s).pipe((0,u.mergeMap)(t=>this.loadAdditionalInfo(t)),(0,u.map)(t=>({success:!0,errorInfo:null,result:t.map(l=>this.entityConverter.getEntity(l))})),(0,u.catchError)(t=>this.getBaseErrorResponse(t)))}getItem(s){const t=this.getItemByIdEsq(s);return this.queryExecutor.executeSelectQuery(t).pipe((0,u.tap)(l=>{if(!(l&&l[0])){const h=this._translateService.instant(this.absentDataErrorKey);throw new Error(h)}}),(0,u.mergeMap)(l=>this.loadAdditionalInfo(l)),(0,u.map)(l=>({success:!0,errorInfo:null,result:[this.entityConverter.getEntity(l[0])]})),(0,u.catchError)(l=>this.getBaseErrorResponse(l)))}insertItem(s){const t=this.getInsertQuery(s),l=this.queryExecutor.executeInsertQuery(t);return this.handleResponse(l)}updateItem(s){const t=this.getUpdateQuery(s),l=this.queryExecutor.executeUpdateQuery(t);return this.handleResponse(l)}deleteItem(s){const t=this.getDeleteQuery(s),l=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(l)}deleteById(s){const t=this.getDeleteQueryWithPrimaryColumnFilter(s),l=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(l)}}},12434:(lt,S,n)=>{n.r(S),n.d(S,{AcceptChatHandler:()=>k,AcceptChatRequest:()=>ot,BaseLoadInProgressChatsConverter:()=>j,CrtContactCenterModule:()=>J,CrtIncomingItemListPreprocessor:()=>B,LoadInProgressChatsConverter:()=>H,LoadNotAcceptedChatsConverter:()=>Q,MergeIncomingItemsConverter:()=>V,SubscribeToChatUpdateHandler:()=>G,SubscribeToChatUpdateRequest:()=>rt,SubscribeToCtiEventsHandler:()=>z,SubscribeToCtiEventsRequest:()=>at,ViewModelCollectionToIncomingItemsArray:()=>$});var c=n(5960),v=n(40297),A=n(55642),C=n(79772),b=n(48629),E=n(90895),U=n(65269),u=n(69015),L=n(17371),R=n(24091),T=n(31149),s=n(12841),t=n(59131),l=n(34760),h=n(77592),Y=n(1034),K=n(96677),F=n(68712),q=n(79111),M=n(73308),O=n(6530),ht=n(91775),r=n(2703),a=n(56027),m=n(41314),y=n(90983),f=n(28399),N=n(30046),pt=n.n(N),ut=n(53703),gt=n(92340),Ct=n(80615),vt=n(20405),yt=n(64),_t=n(62115);const ft=d=>({"item-outdated":d});function It(d,e){d&1&&(t.\u0275\u0275elementStart(0,"crt-chip",12),t.\u0275\u0275text(1," Input due "),t.\u0275\u0275elementEnd())}function Et(d,e){if(d&1){const o=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"div",13)(1,"crt-button",14),t.\u0275\u0275pipe(2,"translate"),t.\u0275\u0275listener("clicked",function(){t.\u0275\u0275restoreView(o);const p=t.\u0275\u0275nextContext();return t.\u0275\u0275resetView(p.onAcceptClick())}),t.\u0275\u0275elementEnd()()}d&2&&(t.\u0275\u0275advance(),t.\u0275\u0275property("caption",t.\u0275\u0275pipeBind1(2,1,"IncomingItemList.AcceptButtonLabel")))}let w=class X extends F.K{constructor(){super(...arguments),this._defaultDate=new Date,this._outdateDelay=0,this.timerType=r.a.Stopwatch,this.acceptClick=new t.EventEmitter}set data(e){this._incomingItem=e,this._setOutdateTimer()}get isOutdated(){const e=this._getTimeBeforeOutdate();return!!e&&e>=this._outdateDelay}set outdateDelay(e){this._outdateDelay=e*60,this._setOutdateTimer()}get incomingItem(){return this._incomingItem}get icon(){let e=this._incomingItem?.schemaName?.toLowerCase();return a.z.includes(e)||(e="default"),`${e}-entity-icon`}get tileIconKey(){return this._incomingItem?.schemaName||"omnichat"}get ownerId(){return this._incomingItem?.contact?.value}get ownerName(){return this._incomingItem?.contact?.displayValue?.toString()}get ownerNamePlaceholder(){const e=this.ownerName;return(0,f.isEmpty)(e)?"":e[0]}get photoUrl(){const e=this._incomingItem?.contact?.primaryImageValue;return e&&e!==O.To?(0,m.Mc)(e):""}get createdOn(){return this._incomingItem?.createdOn!==void 0?this._incomingItem?.createdOn||this._defaultDate:this._defaultDate}get isNeedAccept(){return this._incomingItem?.accepted===!1}get isPendingDetails(){return!0}get description(){return this._incomingItem?.itemTitle}_openDefaultPage(e,o){return(0,M.A)(function*(){const i={type:"crt.UpdateRecordRequest",entityName:e,recordId:o,$context:null};yield ht.t.instance.process(i)})()}_getTimeBeforeOutdate(){return!this._incomingItem?.createdOn||!this._outdateDelay?null:pt()().diff(this._incomingItem?.createdOn,"seconds",!1)}_setOutdateTimer(){const e=this._getTimeBeforeOutdate();e===null||e>=this._outdateDelay||setTimeout(()=>{this.changeDetectorRef.detectChanges()},(this._outdateDelay-e)*1e3)}onLinkClick(e,o){var i=this;return(0,M.A)(function*(){yield i._openDefaultPage(e,o)})()}get ownerLink(){const e=this.ownerId;return e?(0,y.TX)("Contact",e):""}onAcceptClick(){this.acceptClick.emit(this._incomingItem)}static{this.\u0275fac=(()=>{let e;return function(i){return(e||(e=t.\u0275\u0275getInheritedFactory(X)))(i||X)}})()}static{this.\u0275cmp=t.\u0275\u0275defineComponent({type:X,selectors:[["crt-incoming-item"]],inputs:{data:"data",outdateDelay:"outdateDelay"},outputs:{acceptClick:"acceptClick"},features:[t.\u0275\u0275InheritDefinitionFeature],decls:15,vars:18,consts:[[1,"icoming-item-tile",3,"ngClass"],[1,"icoming-item-tile-header"],[1,"icoming-item-tile-icon"],[3,"tileKey","icon"],[1,"icoming-item-tile-caption",3,"title"],["class","icoming-item-tile-caption-chip","color","Orange",4,"ngIf"],[1,"icoming-item-tile-footer"],[1,"icoming-item-tile-owner"],["readonly","true","placeholderMode","abbreviation","borderRadius","large","positioning","scale-down","size","none",1,"icoming-item-tile-owner-photo",3,"value","placeholder","colorId"],["mode","'preventDefault'",1,"icoming-item-tile-owner-link",3,"clicked","href"],[1,"icoming-item-tile-date",3,"timerType","control"],["class","icoming-item-tile-actions",4,"ngIf"],["color","Orange",1,"icoming-item-tile-caption-chip"],[1,"icoming-item-tile-actions"],["size","medium","color","accent",3,"clicked","caption"]],template:function(o,i){o&1&&(t.\u0275\u0275elementStart(0,"div",0)(1,"div",1)(2,"div",2),t.\u0275\u0275element(3,"crt-entity-icon",3),t.\u0275\u0275pipe(4,"lowercase"),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(5,"div",4),t.\u0275\u0275text(6),t.\u0275\u0275elementEnd(),t.\u0275\u0275template(7,It,2,0,"crt-chip",5),t.\u0275\u0275elementEnd(),t.\u0275\u0275elementStart(8,"div",6)(9,"div",7),t.\u0275\u0275element(10,"crt-image-input",8),t.\u0275\u0275elementStart(11,"crt-link",9),t.\u0275\u0275listener("clicked",function(){return i.onLinkClick("Contact",i.ownerId)}),t.\u0275\u0275text(12),t.\u0275\u0275elementEnd()(),t.\u0275\u0275element(13,"crt-timer",10),t.\u0275\u0275template(14,Et,3,3,"div",11),t.\u0275\u0275elementEnd()()),o&2&&(t.\u0275\u0275property("ngClass",t.\u0275\u0275pureFunction1(16,ft,i.isOutdated)),t.\u0275\u0275advance(3),t.\u0275\u0275property("tileKey",t.\u0275\u0275pipeBind1(4,14,i.tileIconKey))("icon",i.icon),t.\u0275\u0275advance(2),t.\u0275\u0275property("title",i.description),t.\u0275\u0275advance(),t.\u0275\u0275textInterpolate1(" ",i.description," "),t.\u0275\u0275advance(),t.\u0275\u0275property("ngIf",!1),t.\u0275\u0275advance(3),t.\u0275\u0275property("value",i.photoUrl)("placeholder",i.ownerNamePlaceholder)("colorId",i.ownerId),t.\u0275\u0275advance(),t.\u0275\u0275property("href",i.ownerLink),t.\u0275\u0275advance(),t.\u0275\u0275textInterpolate1(" ",i.ownerName," "),t.\u0275\u0275advance(),t.\u0275\u0275property("timerType",i.timerType)("control",i.createdOn),t.\u0275\u0275advance(),t.\u0275\u0275property("ngIf",i.isNeedAccept))},dependencies:[v.NgClass,v.NgIf,ut.h,gt.g,Ct.j,vt.N,yt.k,_t.B,v.LowerCasePipe,C.TranslatePipe],styles:["body[_ngcontent-%COMP%]{--focus-outline-outer-color: var(--crt-palette-secondary-500);--focus-outline-inner-color: white}.icoming-item-tile[_ngcontent-%COMP%]{height:96px;max-width:100%;border:1px solid var(--crt-palette-interaction-900);border-radius:8px;overflow:auto;background:var(--crt-palette-background-400);padding:5px}.icoming-item-tile.item-outdated[_ngcontent-%COMP%]{border-color:var(--crt-palette-error-500);box-shadow:1px 1px 5px var(--crt-palette-error-500)}.icoming-item-tile[_ngcontent-%COMP%]   crt-chip.icoming-item-tile-caption-chip[_ngcontent-%COMP%]{font-family:var(--crt-body-2-font-family);font-size:var(--crt-body-2-font-size);line-height:var(--crt-body-2-line-height);font-weight:var(--crt-body-2-font-weight);letter-spacing:var(--crt-body-2-letter-spacing);text-transform:var(--crt-body-2-text-transform);-webkit-font-smoothing:antialiased;margin-top:6px;max-width:67px}.icoming-item-tile[_ngcontent-%COMP%]   crt-chip.icoming-item-tile-caption-chip[_ngcontent-%COMP%]   .crt-chip-focus-overlay[_ngcontent-%COMP%]{background-color:#ffd9d0;opacity:.2}.icoming-item-tile.selected[_ngcontent-%COMP%]{background-color:var(--crt-palette-interaction-900)}.icoming-item-tile[_ngcontent-%COMP%]:hover{background-color:var(--crt-palette-interaction-700)}.icoming-item-tile[_ngcontent-%COMP%]:hover   .icoming-item-tile-actions[_ngcontent-%COMP%]{width:100px;display:inline-block}.icoming-item-tile[_ngcontent-%COMP%]:hover   .icoming-item-tile-date[_ngcontent-%COMP%]{display:none}.icoming-item-tile-header[_ngcontent-%COMP%]{display:flex}.icoming-item-tile-footer[_ngcontent-%COMP%]{display:flex;margin:12px 8px 0;align-items:center;height:24px}.icoming-item-tile-caption[_ngcontent-%COMP%]{font-family:var(--crt-body-1-font-family);font-size:var(--crt-body-1-font-size);line-height:var(--crt-body-1-line-height);font-weight:var(--crt-body-1-font-weight);letter-spacing:var(--crt-body-1-letter-spacing);text-transform:var(--crt-body-1-text-transform);-webkit-font-smoothing:antialiased;width:calc(100% - 32px);overflow:hidden;height:2.8em;margin-top:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;text-overflow:ellipsis;cursor:pointer}.icoming-item-tile-owner[_ngcontent-%COMP%]{font-family:var(--crt-caption-font-family);font-size:var(--crt-caption-font-size);line-height:var(--crt-caption-line-height);font-weight:var(--crt-caption-font-weight);letter-spacing:var(--crt-caption-letter-spacing);text-transform:var(--crt-caption-text-transform);-webkit-font-smoothing:antialiased;width:100%;display:inline-flex;overflow:hidden;margin-inline-end:3em}.icoming-item-tile-owner-photo[_ngcontent-%COMP%]{width:16px;display:flex;height:16px;margin-inline-end:8px}.icoming-item-tile-owner-photo[_ngcontent-%COMP%]   .placeholder-abbreviation.no-photo[_ngcontent-%COMP%]{min-width:unset;min-height:unset;line-height:16px;height:16px;width:16px;font-size:8px}.icoming-item-tile-owner-photo[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{object-fit:unset}.icoming-item-tile-owner-link[_ngcontent-%COMP%]{max-width:calc(100% - 24px)}.icoming-item-tile-actions[_ngcontent-%COMP%]{display:none}"]})}};w=(0,c.__decorate)([(0,Y.v)({type:"crt.IncomingItem",reuseStrategy:K.B.Reuse})],w);function Mt(d,e){d&1&&(t.\u0275\u0275elementStart(0,"div",3),t.\u0275\u0275element(1,"crt-label",4),t.\u0275\u0275pipe(2,"translate"),t.\u0275\u0275element(3,"crt-label",5),t.\u0275\u0275pipe(4,"translate"),t.\u0275\u0275elementEnd()),d&2&&(t.\u0275\u0275advance(),t.\u0275\u0275property("caption",t.\u0275\u0275pipeBind1(2,2,"IncomingItemList.NoDataLabel")),t.\u0275\u0275advance(2),t.\u0275\u0275property("caption",t.\u0275\u0275pipeBind1(4,4,"IncomingItemList.NoDataDescription")))}function Ot(d,e){if(d&1){const o=t.\u0275\u0275getCurrentView();t.\u0275\u0275elementStart(0,"div")(1,"div",7)(2,"crt-incoming-item",8),t.\u0275\u0275listener("click",function(){const p=t.\u0275\u0275restoreView(o).$implicit,g=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(g.onItemClick(p))})("acceptClick",function(p){t.\u0275\u0275restoreView(o);const g=t.\u0275\u0275nextContext(2);return t.\u0275\u0275resetView(g.onItemAccept(p))}),t.\u0275\u0275elementEnd()()()}if(d&2){const o=e.$implicit,i=t.\u0275\u0275nextContext(2);t.\u0275\u0275advance(2),t.\u0275\u0275property("data",o)("outdateDelay",i.outdateDelay)}}function Pt(d,e){if(d&1&&t.\u0275\u0275template(0,Ot,3,2,"div",6),d&2){const o=t.\u0275\u0275nextContext();t.\u0275\u0275property("ngForOf",o.items)}}let P=class Z extends F.K{constructor(){super(...arguments),this.tileClick=new t.EventEmitter,this.itemAccept=new t.EventEmitter,this.outdateDelay=0}set items(e){this._items=e}get items(){return this._items}onItemClick(e){this.tileClick.emit(e)}onItemAccept(e){this.itemAccept.emit(e)}static{this.\u0275fac=(()=>{let e;return function(i){return(e||(e=t.\u0275\u0275getInheritedFactory(Z)))(i||Z)}})()}static{this.\u0275cmp=t.\u0275\u0275defineComponent({type:Z,selectors:[["crt-incoming-item-list"]],inputs:{outdateDelay:"outdateDelay",items:"items"},outputs:{tileClick:"tileClick",itemAccept:"itemAccept"},features:[t.\u0275\u0275InheritDefinitionFeature],decls:4,vars:2,consts:[["incoming_items",""],[1,"incoming-item-list"],["class","incoming-item-list-no-data",4,"ngIf","ngIfElse"],[1,"incoming-item-list-no-data"],[1,"incoming-item-list-no-data-label",3,"caption"],[1,"incoming-item-list-no-data-description",3,"caption"],[4,"ngFor","ngForOf"],[1,"incoming-item-wrapper"],[3,"click","acceptClick","data","outdateDelay"]],template:function(o,i){if(o&1&&(t.\u0275\u0275elementStart(0,"div",1),t.\u0275\u0275template(1,Mt,5,6,"div",2)(2,Pt,1,1,"ng-template",null,0,t.\u0275\u0275templateRefExtractor),t.\u0275\u0275elementEnd()),o&2){const p=t.\u0275\u0275reference(3);t.\u0275\u0275advance(),t.\u0275\u0275property("ngIf",(i.items==null?null:i.items.length)===0)("ngIfElse",p)}},dependencies:[v.NgForOf,v.NgIf,q.V,w,C.TranslatePipe],styles:[".incoming-item-list[_ngcontent-%COMP%]{width:100%}.incoming-item-list[_ngcontent-%COMP%]   .incoming-item-wrapper[_ngcontent-%COMP%]{padding:5px}.incoming-item-list-no-data[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;height:100%}.incoming-item-list-no-data-label[_ngcontent-%COMP%]{margin-top:35px}.incoming-item-list-no-data-description[_ngcontent-%COMP%]{margin-top:16px}"]})}};(0,c.__decorate)([(0,l.j)(),(0,c.__metadata)("design:type",Object)],P.prototype,"tileClick",void 0),(0,c.__decorate)([(0,l.j)(),(0,c.__metadata)("design:type",Object)],P.prototype,"itemAccept",void 0),(0,c.__decorate)([(0,h.k)(),(0,c.__metadata)("design:type",Object)],P.prototype,"outdateDelay",void 0),(0,c.__decorate)([(0,h.k)({reuseStrategy:{resetValue:!0}}),(0,c.__metadata)("design:type",Array),(0,c.__metadata)("design:paramtypes",[Array])],P.prototype,"items",null),P=(0,c.__decorate)([(0,Y.v)({type:"crt.IncomingItems",reuseStrategy:K.B.Reuse})],P);var W=n(4164),mt=n(56704),I=n(62278);let j=class{constructor(e){this._omnichannelChatService=e,this._chatSchemaName="OmniChat"}getChats(e){return(0,I.lastValueFrom)(this._omnichannelChatService.getOperatorChats().pipe((0,I.filter)(o=>o.success),(0,I.map)(o=>o.result),(0,I.map)(o=>o.filter(i=>e?i.operator.value:!i.operator.value).map(i=>({schemaName:this._chatSchemaName,id:i.id,contact:i.contact?{value:i.contact.id,displayValue:i.contact.name,primaryImageValue:i.contact.photoId}:null,accepted:e,itemTitle:i.chatPreview,createdOn:i.lastMessageTime,additionalParams:{chatQueueId:i.chatQueueId,status:i.status,channel:i.channel,lastMessageTime:i.lastMessageTime,unprocessedMsgCount:i.unprocessedMsgCount,operator:i.operator,closeDate:i.closeDate,completionDate:i.completionDate,lastMessageDirection:i.lastMessageDirection,channelId:i.channelId}})))))}};j=(0,c.__decorate)([(0,W.a)(),(0,c.__metadata)("design:paramtypes",[mt.I])],j);let H=class extends j{convert(){return this.getChats(!0)}};H=(0,c.__decorate)([(0,W.a)({type:"crt.LoadInProgressChats"})],H);let Q=class extends j{convert(){return this.getChats(!1)}};Q=(0,c.__decorate)([(0,W.a)({type:"crt.LoadNotAcceptedChats"})],Q);let V=class{convert(e){return e.flat().filter(o=>!!o)}};V=(0,c.__decorate)([(0,W.a)({type:"crt.MergeIncomingItems"})],V);let $=class{convert(e,o,i){return(0,M.A)(function*(){return!e||e.length===0||!i?[]:yield Promise.all(e.map(function(){var g=(0,M.A)(function*(_){return{schemaName:(yield _.getPrimaryDataSchema()).name,id:yield _[i.id],itemTitle:yield _[i.itemTitle],createdOn:yield _[i.createdOn],contact:yield _[i.contact],accepted:!0}});return function(_){return g.apply(this,arguments)}}()))})()}};$=(0,c.__decorate)([(0,W.a)({type:"crt.ViewModelCollectionToIncomingItemsArray"})],$);var tt=n(81517),et=n(2828),nt=n(41287),it=n(844),At=n(40968),Tt=n(22592),Dt=n(99298);const xt="OmniChat";let ot=class extends tt.S{};ot=(0,c.__decorate)([(0,et.$)({type:"crt.AcceptChatRequest"})],ot);let k=class extends nt.l{constructor(e,o){super(),this._omnichannelChatService=e,this._maskService=o}handle(e){var o=this;return(0,M.A)(function*(){if(e.incomingItem){const i=e.incomingItem.schemaName,p=e.incomingItem.id;if(i===xt){const g=`ACCEPT_CHAT_${p}`;yield o._maskService.showMask(g,e.$context),yield(0,I.lastValueFrom)(o._omnichannelChatService.acceptChat(p)),yield o._maskService.hideMask(g,e.$context)}}yield o.next?.handle(e)})()}};k=(0,c.__decorate)([(0,it.l)({requestType:"crt.AcceptChatRequest",type:"crt.AcceptChatHandler"}),(0,c.__param)(1,(0,At.j)(Dt.V)),(0,c.__metadata)("design:paramtypes",[mt.I,Tt.s])],k);var St=n(5240),dt=n(65576);let rt=class extends tt.S{};rt=(0,c.__decorate)([(0,et.$)({type:"crt.SubscribeToChatUpdateRequest"})],rt);let G=class extends nt.l{constructor(e){super(),this._messageChannelService=e}_subscribeViewModelEvents(e){const o=e.$context;let i=null;const p=new I.Subscription;p.add(o.events$.pipe((0,I.filter)(({type:g})=>g===dt.n.FinishLoadModelAttributes)).subscribe({next:g=>{i=this._messageChannelService.messageEvent$.pipe((0,I.filter)(_=>["AcceptChat","NewIncomingChat","NewTransferredChat","CompleteChat"].includes(_?.header?.sender))).subscribe(()=>{this.handlerChain.process({type:"crt.ReloadChats",$context:o,scopes:e.scopes}).then()})},complete:()=>{i.unsubscribe(),p.unsubscribe()}}))}handle(e){var o=this;return(0,M.A)(function*(){yield o.next?.handle(e),o._subscribeViewModelEvents(e)})()}};G=(0,c.__decorate)([(0,it.l)({requestType:"crt.SubscribeToChatUpdateRequest",type:"crt.SubscribeToChatUpdateHandler"}),(0,c.__metadata)("design:paramtypes",[St.A])],G);var bt=n(59969);let at=class extends tt.S{};at=(0,c.__decorate)([(0,et.$)({type:"crt.SubscribeToCtiEventsRequest"})],at);let z=class extends nt.l{constructor(e){super(),this._customEventService=e}_subscribeViewModelEvents(e){const o=e.$context;let i=null;const p=new I.Subscription;p.add(o.events$.pipe((0,I.filter)(({type:g})=>g===dt.n.FinishLoadModelAttributes)).subscribe({next:g=>{i=this._customEventService.subscribe("CtiModelEvents").subscribe(_=>{const Rt=_[0],D=_[1];o[e.callsAttributeName].then(x=>{switch(Rt){case"callSaved":D.databaseUId&&D.state&&!x.find(st=>st.id===D.databaseUId)&&(x=[...x,{schemaName:"Call",id:D.databaseUId,accepted:!0,itemTitle:D.callerId??D.calledId,createdOn:new Date,contact:null,additionalParams:{ctiPanelCallId:D.id}}],o[e.callsAttributeName]=x);break;case"callFinished":x=x.filter(st=>st.id!==D.databaseUId),o[e.callsAttributeName]=x;break}})})},complete:()=>{i.unsubscribe(),p.unsubscribe()}}))}handle(e){var o=this;return(0,M.A)(function*(){yield o.next?.handle(e),o._subscribeViewModelEvents(e)})()}};z=(0,c.__decorate)([(0,it.l)({requestType:"crt.SubscribeToCtiEventsRequest",type:"crt.SubscribeToCtiEventsHandler"}),(0,c.__metadata)("design:paramtypes",[bt.Dj])],z);var Ut=n(74368);class B{_getViewConfigs(e){return Ut.u.getViewConfigInfoByProperty("type","crt.IncomingItems",e.viewConfig).map(o=>o?.viewConfig).filter(Boolean)}_createItemsAttribute(e,o){if(!(0,f.isEmpty)(e.items)||!e.dataAttributes||(0,f.isEmpty)(e.dataAttributes))return;const i=`IncomingItems_${e.name}`,p=o.viewModelConfig.attributes;p[i]={from:e.dataAttributes,converter:"crt.MergeIncomingItems"},e.items=`$${i}`}crtOnMetaDataInit(e){const o=e,i=this._getViewConfigs(o);for(const p of i)this._createItemsAttribute(p,o);return Promise.resolve(e)}static{this.\u0275fac=function(o){return new(o||B)}}static{this.\u0275prov=t.\u0275\u0275defineInjectable({token:B,factory:B.\u0275fac})}}let J=class ct{static{this.\u0275fac=function(o){return new(o||ct)}}static{this.\u0275mod=t.\u0275\u0275defineNgModule({type:ct})}static{this.\u0275inj=t.\u0275\u0275defineInjector({providers:[{provide:s.m,useClass:B,multi:!0}],imports:[v.CommonModule,b.U,E.J,U.a,u.Q,L.Z,R.S,T.q,C.TranslateModule]})}};J=(0,c.__decorate)([(0,A.g)({viewElements:[P,w],converters:[H,Q,V,$],requestHandlers:[k,G,z]})],J),function(){(typeof ngJitMode>"u"||ngJitMode)&&t.\u0275\u0275setNgModuleScope(J,{declarations:[P,w],imports:[v.CommonModule,b.U,E.J,U.a,u.Q,L.Z,R.S,T.q,C.TranslateModule],exports:[P]})}()},56704:(lt,S,n)=>{n.d(S,{I:()=>O});var c=n(63721),v=n.n(c),A=n(49973),C=n(58504),b=n(41108),E=n(56267),U=n(79772),u=n.n(U),L=n(43272),R=n(23872),T=n(62278),s=n.n(T),t=n(36486),l=n.n(t),h=n(59131),Y=n.n(h),K=n(50485),F=n(65751),q=n(14876),M=n(23092);class O extends L.A{static get rowsCount(){return 30}constructor(r,a,m,y,f,N){super(a,m,y),this.rightsService=r,this.httpClient=f,this.userInfo=N,this._serviceUrl="/rest/OmnichannelChatService/",this._canManageChatsOperationCode="CanManageChats",this._cacheChatActions={},this.entitySchemaName="OmniChat"}_postWithChatId(r,a){const m=this._serviceUrl+a;return this.httpClient.post(m,{chatId:r})}_getMessages(r,a){const m=this._serviceUrl+a;return this.httpClient.post(m,{chatId:r}).pipe((0,t.map)(this._mapChatMessage()))}_getAllConversationMessages(r,a,m){const y=new c.HttpHeaders().set("Content-Type","application/json; charset=utf-8"),f=this._serviceUrl+"GetAllConversation";return this.httpClient.post(f,{contactId:r,channelId:a,rowCount:O.rowsCount,rowOffset:m},{headers:y}).pipe((0,t.map)(this._mapChatMessage()))}_mapChatMessage(){return r=>(r.forEach(a=>{a.time=new Date(a.time),a.author=new R.B(a.author.id,a.author.name,a.author.photoId),a.macrosTemplate&&this._handleMessageMacros(a)}),r)}_handleMessageMacros(r){let a;try{a=JSON.parse(r.macrosTemplate.tokens)}catch(m){console.error("Failed to parse tokens:",m)}r.macrosTemplate.tokens=a}acceptChat(r){return this._postWithChatId(r,"AcceptChat")}getAllConversationByChat(r,a=0){const m=new c.HttpHeaders().set("Content-Type","application/json; charset=utf-8"),y=this._serviceUrl+"GetAllConversationByChat";return this.httpClient.post(y,{chatId:r,rowCount:O.rowsCount,rowOffset:a},{headers:m}).pipe((0,t.map)(this._mapChatMessage()))}getAllConversation(r,a,m=0){return this._getAllConversationMessages(r,a,m)}getConversation(r){const a=new c.HttpHeaders().set("Content-Type","application/json; charset=utf-8"),m=this._serviceUrl+"GetConversation";return this.httpClient.post(m,{chatId:r},{headers:a}).pipe((0,t.map)(this._mapChatMessage()))}markAsRead(r){const a=this._serviceUrl+"MarkChatAsRead";this.httpClient.post(a,{chatId:r}).subscribe()}getMessageTemplate(r){const a=this._serviceUrl+"GetUnifiedMessageTemplate";return this.httpClient.post(a,{chatId:r})}getPreviousChatId(r){const a=this._serviceUrl+"GetPreviousChatId";return this.httpClient.post(a,{chatId:r})}sendMessage(r){const a="/rest/OmnichannelOutcomeMessagingService/SendMessage",m={message:r};return this.httpClient.post(a,m)}sendMessageWithAttachments(r,a){const m="/rest/OmnichannelOutcomeMessagingService/SendMessageWithAttachments",y=new FormData;return y.append("message",JSON.stringify(r)),Array.from(a).forEach((f,N)=>{y.append("file"+N,f,f.name)}),this.httpClient.post(m,y)}completeChat(r){return this._postWithChatId(r,"CloseActiveChat")}getOperatorChats(){const r=this._serviceUrl+"GetChats";return this.httpClient.post(r,{operatorId:this.userInfo.id}).pipe((0,t.map)(a=>({success:!0,errorInfo:null,result:a.Chats.map(m=>this.entityConverter.getEntity(m))})),(0,t.catchError)(a=>this.getBaseErrorResponse(a)))}getChatHistory(r){return this._getMessages(r,"GetHistory")}getChatActions(r){if(this._cacheChatActions[r])return(0,T.of)(this._cacheChatActions[r]);const a=this._serviceUrl+"GetChatActions";return this.httpClient.post(a,{chatId:r}).pipe((0,t.tap)(m=>this._cacheChatActions[r]=m))}isOperatorCanManageChats(){return this.rightsService.getCanExecuteOperation(this._canManageChatsOperationCode).pipe((0,t.map)(r=>r))}isOperatorActive(){const r=new A.s("OperatorSession");return r.rowCount=1,r.addSchemaColumn("OperatorState.OperatorAvailable","IsActive"),r.filters.addSchemaColumnFilterWithParameter(C.H.Is_null,"SessionEndDate",null),r.filters.addSchemaColumnFilterWithParameter(C.H.Equal,"SysUser",this.userInfo.id),this.queryExecutor.executeSelectQuery(r).pipe((0,t.map)(a=>a&&a[0].IsActive||!1),(0,t.catchError)(()=>(0,T.of)(!1)))}isOperatorHasActiveChannel(){const r=new A.s("Channel");r.rowCount=1;const a=new b.X;return a.logicalOperation=E.H.Or,a.addSchemaColumnFilterWithParameter(C.H.Equal,"ChatQueue.[ChatQueueOperator:ChatQueue:Id].[SysAdminUnitInRole:SysAdminUnit:Operator].SysAdminUnit",this.userInfo.id),a.addSchemaColumnFilterWithParameter(C.H.Equal,"ChatQueue.[ChatQueueOperator:ChatQueue:Id].[SysAdminUnitInRole:SysAdminUnitRoleId:Operator].SysAdminUnit",this.userInfo.id),r.filters.add(a),r.filters.addSchemaColumnFilterWithParameter(C.H.Equal,"IsActive",!0),this.queryExecutor.executeSelectQuery(r).pipe((0,t.map)(m=>m&&m.length>0||!1),(0,t.catchError)(()=>(0,T.of)(!1)))}hasUncompletedChats(r){const a=this._serviceUrl+"GetHasUncompletedChats";return this.httpClient.post(a,{channelId:r})}static{this.\u0275fac=function(a){return new(a||O)(h.\u0275\u0275inject(K.f),h.\u0275\u0275inject(F.w),h.\u0275\u0275inject(U.TranslateService),h.\u0275\u0275inject(q.K),h.\u0275\u0275inject(c.HttpClient),h.\u0275\u0275inject(M.oq))}}static{this.\u0275prov=h.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"})}}}}]);
